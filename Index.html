<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dompetku Final</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Tesseract.js (OCR) -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            overscroll-behavior-y: none; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden text-slate-800 bg-slate-50">

    <!-- 1. HEADER (Layout Baru) -->
    <header class="bg-indigo-600 text-white pt-6 pb-6 px-6 shadow-md z-30 flex-shrink-0 rounded-b-[2rem]">
        <!-- Top Bar -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-xl font-bold tracking-tight">Dompetku</h1>
                <p class="text-indigo-200 text-xs">Pencatat Keuangan Pintar</p>
            </div>
            <button onclick="toggleSettings()" class="bg-white/10 hover:bg-white/20 p-2 rounded-full transition-colors">
                <i class="fas fa-cog text-white"></i>
            </button>
        </div>
        
        <!-- Total Balance (Centered & Big) -->
        <div class="text-center mb-6">
            <p class="text-indigo-200 text-xs uppercase font-bold tracking-widest mb-1">Total Saldo Saat Ini</p>
            <h2 class="text-4xl font-extrabold tracking-tight" id="headerBalance">Rp 0</h2>
        </div>

        <!-- Income / Expense Grid (Moved Down) -->
        <div class="grid grid-cols-2 gap-4">
            <!-- Pemasukan Box -->
            <div class="bg-indigo-700/60 p-3 rounded-2xl flex flex-col justify-center border border-indigo-500/30 backdrop-blur-sm">
                <div class="flex items-center gap-2 mb-1 text-emerald-300">
                    <div class="bg-emerald-500/20 p-1.5 rounded-lg">
                        <i class="fas fa-arrow-down text-xs"></i>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-wider">Pemasukan</span>
                </div>
                <p class="font-bold text-lg truncate" id="headerIncome">0</p>
            </div>

            <!-- Pengeluaran Box -->
            <div class="bg-indigo-700/60 p-3 rounded-2xl flex flex-col justify-center border border-indigo-500/30 backdrop-blur-sm">
                <div class="flex items-center gap-2 mb-1 text-rose-300">
                    <div class="bg-rose-500/20 p-1.5 rounded-lg">
                        <i class="fas fa-arrow-up text-xs"></i>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-wider">Pengeluaran</span>
                </div>
                <p class="font-bold text-lg truncate" id="headerExpense">0</p>
            </div>
        </div>
    </header>

    <!-- 2. MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto no-scrollbar relative">
        <div class="p-5 space-y-5 pb-32"> <!-- Extra padding for floating bar -->
            
            <!-- Chart Section -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 text-sm mb-4 flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    Analisis Pengeluaran
                </h3>
                <div class="h-48 relative w-full flex justify-center">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div>
                <div class="flex justify-between items-end mb-4 px-1">
                    <h3 class="font-bold text-slate-700 text-sm">Riwayat Transaksi</h3>
                    <button onclick="exportData()" class="text-[10px] text-indigo-600 font-bold bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition-colors">
                        <i class="fas fa-download mr-1"></i> Backup
                    </button>
                </div>
                <div id="historyList" class="space-y-3">
                    <!-- Javascript populates this -->
                </div>
            </div>
        </div>
    </main>

    <!-- 3. FLOATING ACTION BAR -->
    <div class="absolute bottom-6 left-0 right-0 px-6 z-20 pointer-events-none">
        <div class="flex gap-3 pointer-events-auto bg-white/80 backdrop-blur-md p-2 shadow-[0_8px_30px_rgb(0,0,0,0.12)] rounded-3xl border border-white/50">
            <!-- Manual Button -->
            <button onclick="openModal('manual')" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3.5 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-transform active:scale-95">
                <i class="fas fa-pen"></i> Manual
            </button>
            
            <!-- Scan / Upload Button -->
            <button onclick="triggerFileSelect()" class="flex-[1.5] bg-indigo-600 text-white hover:bg-indigo-700 py-3.5 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-transform active:scale-95 shadow-lg shadow-indigo-500/30">
                <i class="fas fa-camera"></i> Scan / Upload
            </button>
            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
        </div>
    </div>

    <!-- 4. TRANSACTION MODAL -->
    <div id="transactionModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 modal-enter max-w-md mx-auto h-[90vh] flex flex-col shadow-2xl">
            
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <div>
                    <h3 class="text-xl font-bold text-slate-800" id="modalTitle">Tambah Data</h3>
                    <p class="text-slate-400 text-xs">Isi detail transaksi di bawah</p>
                </div>
                <button onclick="closeModal()" class="bg-slate-100 w-8 h-8 flex items-center justify-center rounded-full text-slate-500 hover:text-slate-800 hover:bg-slate-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Scrollable Form Area -->
            <div class="overflow-y-auto flex-1 pb-6 no-scrollbar">
                <form id="transactionForm" class="space-y-6">
                    
                    <!-- Scan Preview Image -->
                    <div id="imagePreviewContainer" class="hidden">
                        <div class="relative w-full h-40 rounded-2xl overflow-hidden border-2 border-slate-100 bg-slate-50 group">
                            <img id="receiptPreview" class="w-full h-full object-cover opacity-90 transition-transform group-hover:scale-105" alt="Preview Struk">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end justify-center pb-2">
                                <span class="text-white text-[10px] font-medium px-2 py-1 rounded-full bg-white/20 backdrop-blur-sm border border-white/10">Bukti Foto Terlampir</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Result Box -->
                    <div id="scanInfoBox" class="hidden bg-gradient-to-r from-indigo-50 to-white p-4 rounded-2xl border border-indigo-100 flex items-start gap-4">
                        <div class="bg-white p-2.5 rounded-xl text-indigo-600 shadow-sm border border-indigo-50">
                            <i class="fas fa-magic text-lg"></i>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-wide mb-1">AI Smart Detect</p>
                            <p id="scanResultText" class="text-sm font-semibold text-indigo-900 leading-snug">Mendeteksi...</p>
                        </div>
                    </div>

                    <!-- Transaction Type Toggle -->
                    <div class="flex bg-slate-100 p-1.5 rounded-2xl">
                        <button type="button" onclick="setTxType('expense')" id="btnExpense" class="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-rose-500 shadow-md transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-arrow-up"></i> Pengeluaran
                        </button>
                        <button type="button" onclick="setTxType('income')" id="btnIncome" class="flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-white/60 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-arrow-down"></i> Pemasukan
                        </button>
                    </div>
                    <input type="hidden" id="typeInput" value="expense">

                    <!-- Amount Input -->
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Nominal (Rp)</label>
                        <div class="relative group">
                            <span class="absolute left-4 top-4 text-slate-400 font-bold text-lg group-focus-within:text-indigo-600 transition-colors">Rp</span>
                            <input type="number" id="amountInput" placeholder="0" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl pl-12 pr-4 py-3.5 text-2xl font-bold text-slate-800 focus:outline-none focus:border-indigo-500 focus:bg-white transition-all placeholder-slate-300">
                        </div>
                    </div>

                    <!-- Category Grid -->
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Kategori</label>
                        <div class="grid grid-cols-3 gap-3" id="categoryGrid">
                            <!-- Populated by JS -->
                        </div>
                        <input type="hidden" id="categoryInput" value="Lainnya">
                    </div>

                    <!-- Details -->
                    <div class="grid grid-cols-1 gap-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Keterangan</label>
                            <input type="text" id="descInput" placeholder="Contoh: Nasi Padang" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3.5 text-sm font-semibold focus:outline-none focus:border-indigo-500 focus:bg-white transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Tanggal</label>
                            <input type="date" id="dateInput" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-3.5 text-sm font-semibold focus:outline-none focus:border-indigo-500 focus:bg-white text-slate-600">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Submit Button -->
            <div class="pt-4 mt-2">
                <button onclick="submitForm()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-xl shadow-indigo-200 hover:bg-indigo-700 active:scale-[0.98] transition-all flex justify-center items-center gap-2 text-lg">
                    <i class="fas fa-check-circle"></i> Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Scan Loader Overlay -->
    <div id="scanLoader" class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-center bg-white/95 backdrop-blur-xl">
        <div class="relative">
            <div class="absolute inset-0 bg-indigo-500 blur-xl opacity-20 rounded-full"></div>
            <div class="loader mb-8 relative z-10 scale-125"></div>
        </div>
        <h3 class="font-bold text-xl text-slate-800 mb-2">Memproses Struk...</h3>
        <p class="text-sm text-slate-500 max-w-xs text-center px-6 leading-relaxed">AI sedang membaca nominal dan kategori dari foto yang Anda upload.</p>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 transition-all">
        <div class="bg-white rounded-[2rem] p-6 w-full max-w-xs shadow-2xl transform scale-100 transition-transform">
            <div class="text-center mb-6">
                <div class="bg-indigo-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-600">
                    <i class="fas fa-cog text-xl"></i>
                </div>
                <h3 class="font-bold text-lg text-slate-800">Pengaturan</h3>
            </div>
            
            <div class="space-y-3">
                <button onclick="document.getElementById('importInput').click()" class="w-full bg-white text-indigo-700 py-3.5 rounded-xl font-bold text-sm border-2 border-indigo-100 hover:bg-indigo-50 transition-colors flex items-center justify-center gap-2 group">
                    <i class="fas fa-file-import group-hover:-translate-y-0.5 transition-transform"></i> Restore Data JSON
                </button>
                <input type="file" id="importInput" class="hidden" accept=".json" onchange="importData(this)">
                
                <button onclick="clearData()" class="w-full bg-white text-rose-600 py-3.5 rounded-xl font-bold text-sm border-2 border-rose-100 hover:bg-rose-50 transition-colors flex items-center justify-center gap-2 group">
                    <i class="fas fa-trash-alt group-hover:rotate-12 transition-transform"></i> Reset Aplikasi
                </button>
            </div>
            <button onclick="toggleSettings()" class="w-full mt-6 py-2 text-slate-400 text-sm font-bold hover:text-slate-600 transition-colors">Tutup</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[70] text-sm font-bold whitespace-nowrap -translate-y-10 flex items-center gap-2">
        <i class="fas fa-info-circle text-indigo-400"></i> <span id="toastMsg">Notifikasi</span>
    </div>

    <script>
        // --- DATA STATE ---
        let transactions = JSON.parse(localStorage.getItem('dompetku_data')) || [];
        let chartInstance = null;

        const CATEGORIES = {
            expense: [
                { id: 'Makan', icon: 'fa-utensils', color: 'bg-orange-100 text-orange-600', keywords: ['kfc', 'mcd', 'warung', 'sate', 'nasi', 'mie', 'kopi', 'cafe', 'resto', 'food'] },
                { id: 'Transport', icon: 'fa-car-side', color: 'bg-blue-100 text-blue-600', keywords: ['gojek', 'grab', 'uber', 'bensin', 'pertamina', 'shell', 'parkir', 'tol', 'travel'] },
                { id: 'Belanja', icon: 'fa-shopping-cart', color: 'bg-emerald-100 text-emerald-600', keywords: ['indomaret', 'alfamart', 'superindo', 'hypermart', 'toko', 'store', 'market'] },
                { id: 'Tagihan', icon: 'fa-bolt', color: 'bg-yellow-100 text-yellow-600', keywords: ['pln', 'token', 'air', 'pam', 'wifi', 'internet', 'pulsa', 'telkomsel', 'xl', 'indosat'] },
                { id: 'Hiburan', icon: 'fa-film', color: 'bg-purple-100 text-purple-600', keywords: ['bioskop', 'cgv', 'xxi', 'game', 'steam', 'netflix', 'spotify', 'youtube'] },
                { id: 'Lainnya', icon: 'fa-box-open', color: 'bg-gray-100 text-gray-600', keywords: [] }
            ],
            income: [
                { id: 'Gaji', icon: 'fa-money-bill-wave', color: 'bg-green-100 text-green-600' },
                { id: 'Bonus', icon: 'fa-gift', color: 'bg-pink-100 text-pink-600' },
                { id: 'Jualan', icon: 'fa-store', color: 'bg-teal-100 text-teal-600' },
                { id: 'Lainnya', icon: 'fa-plus-circle', color: 'bg-gray-100 text-gray-600' }
            ]
        };

        // --- INIT & UI UPDATES ---
        const init = () => {
            document.getElementById('dateInput').valueAsDate = new Date();
            renderCategoryGrid('expense');
            updateUI();
        };

        const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);

        const saveData = () => {
            localStorage.setItem('dompetku_data', JSON.stringify(transactions));
            updateUI();
        };

        const updateUI = () => {
            const inc = transactions.filter(t => t.type === 'income').reduce((a, b) => a + b.amount, 0);
            const exp = transactions.filter(t => t.type === 'expense').reduce((a, b) => a + b.amount, 0);
            const bal = inc - exp;

            document.getElementById('headerBalance').innerText = formatRupiah(bal);
            document.getElementById('headerIncome').innerText = formatRupiah(inc);
            document.getElementById('headerExpense').innerText = formatRupiah(exp);

            updateChart(inc, exp);
            renderHistory();
        };

        // --- CHART ---
        const updateChart = (inc, exp) => {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const expenseData = transactions.filter(t => t.type === 'expense').reduce((acc, curr) => {
                acc[curr.category] = (acc[curr.category] || 0) + curr.amount;
                return acc;
            }, {});

            const labels = Object.keys(expenseData);
            const data = Object.values(expenseData);
            const colors = ['#f97316', '#3b82f6', '#10b981', '#eab308', '#a855f7', '#94a3b8'];

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.length ? labels : ['Kosong'],
                    datasets: [{
                        data: data.length ? data : [1],
                        backgroundColor: data.length ? colors : ['#f1f5f9'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: { 
                        legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true, font: {size: 11, family: "'Plus Jakarta Sans', sans-serif"} } } 
                    },
                    layout: { padding: 10 }
                }
            });
        };

        // --- LIST RENDER ---
        const renderHistory = () => {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            if (transactions.length === 0) return list.innerHTML = `
                <div class="text-center py-12 flex flex-col items-center opacity-50">
                    <div class="bg-slate-100 p-4 rounded-full mb-3">
                        <i class="fas fa-receipt text-3xl text-slate-400"></i>
                    </div>
                    <p class="text-slate-500 font-medium">Belum ada transaksi</p>
                    <p class="text-slate-400 text-xs">Yuk mulai catat pengeluaranmu!</p>
                </div>`;

            const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            sorted.forEach(t => {
                const isInc = t.type === 'income';
                const catInfo = CATEGORIES[t.type].find(c => c.id === t.category) || CATEGORIES[t.type][CATEGORIES[t.type].length-1];

                const el = document.createElement('div');
                el.className = `bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center group active:scale-[0.99] transition-transform`;
                el.innerHTML = `
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="w-12 h-12 rounded-2xl ${catInfo.color} flex items-center justify-center flex-shrink-0 shadow-sm">
                            <i class="fas ${catInfo.icon} text-lg"></i>
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-bold text-slate-700 text-sm truncate">${t.description}</h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md uppercase tracking-wider">${t.category}</span>
                                <span class="text-[10px] text-slate-400">${new Date(t.date).toLocaleDateString('id-ID', {day:'numeric', month:'short'})}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right pl-2">
                        <p class="font-bold text-sm ${isInc ? 'text-emerald-600' : 'text-rose-600'} whitespace-nowrap">
                            ${isInc ? '+' : '-'} ${formatRupiah(t.amount)}
                        </p>
                        <button onclick="deleteTx(${t.id})" class="text-[10px] text-slate-300 hover:text-rose-500 mt-1 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                            <i class="fas fa-trash-alt"></i> Hapus
                        </button>
                    </div>
                `;
                list.appendChild(el);
            });
        };

        // --- CATEGORY GRID ---
        const renderCategoryGrid = (type) => {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            CATEGORIES[type].forEach(cat => {
                const btn = document.createElement('div');
                btn.className = 'cat-btn cursor-pointer border-2 border-slate-100 rounded-2xl p-3 flex flex-col items-center justify-center gap-2 hover:bg-indigo-50 hover:border-indigo-100 transition-all group';
                btn.dataset.id = cat.id;
                btn.onclick = () => selectCategory(cat.id, btn);
                btn.innerHTML = `
                    <i class="fas ${cat.icon} text-slate-400 text-xl mb-1 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-slate-400">${cat.id}</span>
                `;
                grid.appendChild(btn);
            });
            // Default select first
            if(grid.children[0]) selectCategory(CATEGORIES[type][0].id, grid.children[0]);
        };

        const selectCategory = (id, el) => {
            document.getElementById('categoryInput').value = id;
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.className = 'cat-btn cursor-pointer border-2 border-slate-100 rounded-2xl p-3 flex flex-col items-center justify-center gap-2 hover:bg-slate-50 transition-all';
                b.querySelector('i').classList.replace('text-indigo-600', 'text-slate-400');
                b.querySelector('span').classList.replace('text-indigo-600', 'text-slate-400');
            });
            el.className = 'cat-btn cursor-pointer border-2 border-indigo-500 bg-indigo-50 rounded-2xl p-3 flex flex-col items-center justify-center gap-2 shadow-sm transform scale-[1.02] transition-all';
            el.querySelector('i').classList.replace('text-slate-400', 'text-indigo-600');
            el.querySelector('span').classList.replace('text-slate-400', 'text-indigo-600');
        };

        // --- FORM & MODAL ---
        const openModal = (mode) => {
            const modal = document.getElementById('transactionModal');
            modal.classList.remove('hidden');
            
            // Reset Preview State
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('scanInfoBox').classList.add('hidden');
            document.getElementById('modalTitle').innerText = mode === 'scan' ? 'Verifikasi Scan' : 'Input Manual';
        };

        const closeModal = () => document.getElementById('transactionModal').classList.add('hidden');

        const setTxType = (type) => {
            document.getElementById('typeInput').value = type;
            renderCategoryGrid(type);
            
            const btnExp = document.getElementById('btnExpense');
            const btnInc = document.getElementById('btnIncome');
            
            if(type === 'expense') {
                btnExp.className = "flex-1 py-3 rounded-xl text-sm font-bold text-white bg-rose-500 shadow-md transition-all flex items-center justify-center gap-2";
                btnInc.className = "flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-white/60 transition-all flex items-center justify-center gap-2";
            } else {
                btnInc.className = "flex-1 py-3 rounded-xl text-sm font-bold text-white bg-emerald-500 shadow-md transition-all flex items-center justify-center gap-2";
                btnExp.className = "flex-1 py-3 rounded-xl text-sm font-bold text-slate-500 hover:bg-white/60 transition-all flex items-center justify-center gap-2";
            }
        };

        const submitForm = () => {
            const desc = document.getElementById('descInput').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            
            if(!desc || !amount) return showToast("Mohon lengkapi data", true);

            transactions.push({
                id: Date.now(),
                description: desc,
                amount: amount,
                type: document.getElementById('typeInput').value,
                category: document.getElementById('categoryInput').value,
                date: document.getElementById('dateInput').value
            });
            
            saveData();
            closeModal();
            
            // Reset fields
            document.getElementById('descInput').value = '';
            document.getElementById('amountInput').value = '';
            showToast("Transaksi berhasil disimpan");
        };

        // --- OCR & FILE HANDLING ---
        const triggerFileSelect = () => document.getElementById('fileInput').click();

        const handleFileSelect = async (input) => {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const loader = document.getElementById('scanLoader');
            loader.classList.remove('hidden');

            // 1. Show Image Preview immediately
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('receiptPreview').src = e.target.result;
                document.getElementById('imagePreviewContainer').classList.remove('hidden');
            };
            reader.readAsDataURL(file);

            try {
                // 2. Process OCR
                const worker = await Tesseract.createWorker('eng');
                const ret = await worker.recognize(file);
                const text = ret.data.text.toLowerCase();
                await worker.terminate();

                // 3. Logic Detection
                // Find Amount
                const numbers = text.match(/\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?/g);
                let amount = 0;
                if(numbers) {
                    const valid = numbers.map(n => parseFloat(n.replace(/[.,]/g, '')))
                                       .filter(n => n > 500 && n < 100000000); // Max 100jt limit detection for safety
                    if(valid.length) amount = Math.max(...valid);
                }

                // Find Category
                let category = 'Lainnya';
                let desc = 'Belanja (Scan)';
                
                const cats = CATEGORIES.expense; 
                for (const cat of cats) {
                    if (cat.keywords && cat.keywords.some(k => text.includes(k))) {
                        category = cat.id;
                        desc = `${cat.id} (Scan)`;
                        break;
                    }
                }

                // 4. Populate Form
                setTxType('expense');
                document.getElementById('amountInput').value = amount;
                document.getElementById('descInput').value = desc;
                
                // Select Category in UI
                setTimeout(() => {
                    const grid = document.getElementById('categoryGrid');
                    const catBtn = [...grid.children].find(b => b.dataset.id === category);
                    if(catBtn) selectCategory(category, catBtn);
                }, 100);

                // Show Modal
                loader.classList.add('hidden');
                openModal('scan');
                document.getElementById('scanInfoBox').classList.remove('hidden');
                document.getElementById('scanResultText').innerHTML = `Kategori: <span class="font-bold">${category}</span><br>Total: <span class="font-bold">${formatRupiah(amount)}</span>`;

            } catch (err) {
                console.error(err);
                loader.classList.add('hidden');
                showToast("Gagal memproses gambar", true);
            }
            
            input.value = ''; // Reset input
        };

        // --- UTILS ---
        const showToast = (msg, error = false) => {
            const el = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            el.className = `fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl z-[70] text-sm font-bold whitespace-nowrap transition-all duration-300 flex items-center gap-2 ${error ? 'bg-rose-500 text-white' : 'bg-slate-900 text-white'}`;
            
            el.style.opacity = '1';
            el.style.transform = 'translate(-50%, 0)';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translate(-50%, -40px)';
            }, 3000);
        };

        const deleteTx = (id) => {
            if(confirm('Hapus transaksi?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                showToast("Data dihapus");
            }
        }

        const toggleSettings = () => document.getElementById('settingsModal').classList.toggle('hidden');
        const clearData = () => { if(confirm('Hapus SEMUA data?')) { transactions=[]; saveData(); toggleSettings(); } };
        
        const exportData = () => {
            const blob = new Blob([JSON.stringify(transactions)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup_dompetku_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };

        const importData = (input) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try { transactions = JSON.parse(e.target.result); saveData(); toggleSettings(); showToast("Data dipulihkan"); }
                catch { showToast("File error", true); }
            };
            if(input.files[0]) reader.readAsText(input.files[0]);
        };

        init();
    </script>
</body>
</html>

