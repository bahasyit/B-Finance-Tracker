<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Sona - Financial Planner with AI</title>
    
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sona">
    
    <!-- Icon Aplikasi untuk iOS (Menggunakan placeholder icon dompet) -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/272/272525.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & Libraries via Import Map for ES Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "lucide-react": "https://esm.sh/lucide-react@0.378.0?deps=react@18.3.1",
        "recharts": "https://esm.sh/recharts@2.12.7?deps=react@18.3.1,react-dom@18.3.1",
        "clsx": "https://esm.sh/clsx",
        "tailwind-merge": "https://esm.sh/tailwind-merge",
        "sonner": "https://esm.sh/sonner@1.4.41?deps=react@18.3.1,react-dom@18.3.1",
        "@google/generative-ai": "https://esm.sh/@google/generative-ai"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            --background: #ffffff;
            --foreground: #020817;
            --card: #ffffff;
            --card-foreground: #020817;
            --popover: #ffffff;
            --popover-foreground: #020817;
            --primary: #0f172a;
            --primary-foreground: #f8fafc;
            --secondary: #f1f5f9;
            --secondary-foreground: #0f172a;
            --muted: #f1f5f9;
            --muted-foreground: #64748b;
            --accent: #f1f5f9;
            --accent-foreground: #0f172a;
            --destructive: #ef4444;
            --destructive-foreground: #f8fafc;
            --border: #e2e8f0;
            --input: #e2e8f0;
            --ring: #020817;
            --radius: 0.75rem;
        }
        
        body {
            font-family: var(--font-sans);
            background-color: #f8fafc;
            color: var(--foreground);
            /* Prevent bounce scrolling on mobile to feel more like an app */
            overscroll-behavior-y: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Markdown Styles */
        .prose h3 { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { color: #0f172a; font-weight: 600; }
        .prose p { margin-bottom: 0.75em; line-height: 1.6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import { 
            LayoutDashboard, 
            Receipt, 
            Wallet as WalletIcon, 
            PiggyBank, 
            Target, 
            Plus, 
            Trash2, 
            ArrowUpCircle, 
            ArrowDownCircle, 
            Filter, 
            CreditCard, 
            Banknote, 
            TrendingUp, 
            TrendingDown, 
            Calendar as CalendarIcon, 
            CheckCircle, 
            AlertCircle,
            X,
            Menu,
            Camera,
            Loader2,
            ChevronDown,
            Sparkles,
            Bot,
            Send,
            Lightbulb,
            Download,
            Upload,
            Save,
            FileJson,
            Settings,
            Key
        } from 'lucide-react';
        import { 
            PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip as RechartsTooltip, 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, LineChart, Line 
        } from 'recharts';
        import { Toaster, toast } from 'sonner';
        import { clsx } from 'clsx';
        import { twMerge } from 'tailwind-merge';

        // --- GEMINI HELPER ---
        // Dynamically create model instance based on provided key
        function getGeminiModel(apiKey) {
            if (!apiKey) return null;
            const genAI = new GoogleGenerativeAI(apiKey);
            return genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
        }

        // --- UTILS ---
        function cn(...inputs) {
            return twMerge(clsx(inputs));
        }

        function formatIDR(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(amount);
        }

        async function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve({
                    inlineData: { data: reader.result.split(",")[1], mimeType: file.type },
                });
                reader.readAsDataURL(file);
            });
        }

        // --- UI COMPONENTS ---
        
        const Button = React.forwardRef(({ className, variant = "default", size = "default", ...props }, ref) => {
            const variants = {
                default: "bg-slate-900 text-white hover:bg-slate-900/90",
                destructive: "bg-red-500 text-white hover:bg-red-500/90",
                outline: "border border-slate-200 bg-white hover:bg-slate-100 text-slate-900",
                secondary: "bg-slate-100 text-slate-900 hover:bg-slate-100/80",
                ghost: "hover:bg-slate-100 hover:text-slate-900",
                link: "text-slate-900 underline-offset-4 hover:underline",
                ai: "bg-gradient-to-r from-indigo-500 to-purple-600 text-white hover:from-indigo-600 hover:to-purple-700 border-0 shadow-sm",
            };
            const sizes = {
                default: "h-10 px-4 py-2",
                sm: "h-9 rounded-md px-3",
                lg: "h-11 rounded-md px-8",
                icon: "h-10 w-10",
            };
            return (
                <button
                    ref={ref}
                    className={cn(
                        "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
                        variants[variant],
                        sizes[size],
                        className
                    )}
                    {...props}
                />
            );
        });

        const Input = React.forwardRef(({ className, type, ...props }, ref) => {
            return (
                <input
                    type={type}
                    className={cn(
                        "flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
                        className
                    )}
                    ref={ref}
                    {...props}
                />
            );
        });

        const Card = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("rounded-xl border border-slate-200 bg-white text-slate-950 shadow-sm", className)} {...props} />
        ));
        const CardHeader = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
        ));
        const CardTitle = React.forwardRef(({ className, ...props }, ref) => (
            <h3 ref={ref} className={cn("text-2xl font-semibold leading-none tracking-tight", className)} {...props} />
        ));
        const CardContent = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
        ));

        const Badge = ({ className, variant = "default", ...props }) => {
            const variants = {
                default: "border-transparent bg-slate-900 text-slate-50 hover:bg-slate-900/80",
                secondary: "border-transparent bg-slate-100 text-slate-900 hover:bg-slate-100/80",
                destructive: "border-transparent bg-red-500 text-slate-50 hover:bg-red-500/80",
                outline: "text-slate-950",
                ai: "border-transparent bg-purple-100 text-purple-700",
            };
            return (
                <div className={cn("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-slate-950 focus:ring-offset-2", variants[variant], className)} {...props} />
            );
        };

        const Progress = React.forwardRef(({ className, value, ...props }, ref) => (
            <div ref={ref} className={cn("relative h-4 w-full overflow-hidden rounded-full bg-slate-100", className)} {...props}>
                <div className="h-full w-full flex-1 bg-slate-900 transition-all" style={{ transform: `translateX(-${100 - (value || 0)}%)` }} />
            </div>
        ));

        const Label = React.forwardRef(({ className, ...props }, ref) => (
            <label ref={ref} className={cn("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70", className)} {...props} />
        ));

        const Select = ({ value, onValueChange, children, className }) => (
            <div className="relative">
                <select 
                    value={value} 
                    onChange={(e) => onValueChange(e.target.value)}
                    className={cn("flex h-10 w-full items-center justify-between rounded-md border border-slate-200 bg-white px-3 py-2 text-sm placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-950 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 appearance-none", className)}
                >
                   {children}
                </select>
                <ChevronDown className="absolute right-3 top-3 h-4 w-4 opacity-50 pointer-events-none" />
            </div>
        );
        const SelectItem = ({ value, children }) => <option value={value}>{children}</option>;

        const Dialog = ({ open, onOpenChange, children }) => {
            if (!open) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 animate-in fade-in-0">
                    <div className="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative animate-in zoom-in-95 duration-200 max-h-[90vh] overflow-y-auto">
                        <button onClick={() => onOpenChange(false)} className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-white transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-slate-950 focus:ring-offset-2">
                            <X className="h-4 w-4" />
                            <span className="sr-only">Close</span>
                        </button>
                        {children}
                    </div>
                </div>
            );
        };

        // --- NEW: SETTINGS DIALOG ---
        function SettingsDialog({ isOpen, onOpenChange, apiKey, setApiKey }) {
            const [localKey, setLocalKey] = useState(apiKey);

            const handleSave = () => {
                setApiKey(localKey);
                onOpenChange(false);
                toast.success("API Key berhasil disimpan!");
            };

            return (
                <Dialog open={isOpen} onOpenChange={onOpenChange}>
                    <div className="space-y-4">
                        <div>
                            <h2 className="text-lg font-semibold">Pengaturan Aplikasi</h2>
                            <p className="text-sm text-slate-500">Konfigurasi API Key untuk mengaktifkan fitur AI.</p>
                        </div>
                        
                        <div className="space-y-2">
                            <Label htmlFor="api-key">Gemini API Key</Label>
                            <div className="relative">
                                <Key className="absolute left-3 top-2.5 h-4 w-4 text-slate-400" />
                                <Input 
                                    id="api-key"
                                    value={localKey}
                                    onChange={(e) => setLocalKey(e.target.value)}
                                    placeholder="Tempel API Key Anda di sini..."
                                    className="pl-9"
                                    type="password"
                                />
                            </div>
                            <p className="text-xs text-slate-500">
                                Key ini disimpan di browser Anda (LocalStorage), tidak dikirim ke server kami. 
                                Dapatkan key gratis di <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-600 underline">Google AI Studio</a>.
                            </p>
                        </div>

                        <Button onClick={handleSave} className="w-full">Simpan Pengaturan</Button>
                    </div>
                </Dialog>
            );
        }

        // --- AI COMPONENTS ---

        function AIAdvisor({ transactions, budgets, goals, apiKey, onOpenSettings }) {
            const [advice, setAdvice] = useState("");
            const [isLoading, setIsLoading] = useState(false);

            const generateAdvice = async () => {
                if (!apiKey) {
                    toast.error("API Key belum diatur. Silakan buka pengaturan.");
                    onOpenSettings();
                    return;
                }

                setIsLoading(true);
                try {
                    const model = getGeminiModel(apiKey);
                    if (!model) throw new Error("Failed to initialize model");

                    const totalIncome = transactions.filter(t => t.type === "income").reduce((sum, t) => sum + t.amount, 0);
                    const totalExpenses = transactions.filter(t => t.type === "expense").reduce((sum, t) => sum + t.amount, 0);
                    const topCategories = Object.entries(transactions.filter(t => t.type === "expense").reduce((acc, t) => {
                        acc[t.category] = (acc[t.category] || 0) + t.amount;
                        return acc;
                    }, {})).sort((a, b) => b[1] - a[1]).slice(0, 3).map(([cat, amount]) => `${cat}: ${formatIDR(amount)}`).join(", ");

                    const prompt = `
                        Bertindaklah sebagai penasihat keuangan pribadi yang ramah dan bijaksana untuk aplikasi "Sona".
                        Analisis data keuangan berikut dan berikan:
                        1. Ringkasan singkat kondisi keuangan saat ini.
                        2. Tiga saran praktis untuk berhemat atau mencapai target.
                        
                        Data:
                        - Total Pemasukan: ${formatIDR(totalIncome)}
                        - Total Pengeluaran: ${formatIDR(totalExpenses)}
                        - Saldo: ${formatIDR(totalIncome - totalExpenses)}
                        - Pengeluaran Terbesar: ${topCategories || "Belum ada data"}
                        - Jumlah Target Aktif: ${goals.length}
                        - Status Budget: ${budgets.map(b => `${b.category}: ${Math.round((b.spent/b.limit)*100)}% terpakai`).join(", ")}
                        
                        Gunakan bahasa Indonesia yang santai tapi profesional. Gunakan format Markdown untuk bold dan list.
                    `;

                    const result = await model.generateContent(prompt);
                    const response = await result.response;
                    setAdvice(response.text());
                } catch (error) {
                    console.error("AI Error:", error);
                    toast.error("Gagal mendapatkan saran AI. Periksa API Key Anda.");
                } finally {
                    setIsLoading(false);
                }
            };

            const md = window.markdownit();

            return (
                <div className="space-y-6">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 className="text-3xl font-bold tracking-tight flex items-center gap-2">
                                <Sparkles className="h-8 w-8 text-purple-600" /> Sona AI Advisor
                            </h2>
                            <p className="text-slate-500">Dapatkan wawasan cerdas tentang keuangan Anda</p>
                        </div>
                        <Button 
                            onClick={generateAdvice} 
                            disabled={isLoading}
                            variant="ai"
                            className="w-full md:w-auto"
                        >
                            {isLoading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Bot className="mr-2 h-4 w-4" />}
                            {advice ? "Analisis Ulang" : "Analisis Keuanganku"}
                        </Button>
                    </div>

                    {!apiKey && (
                        <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg flex items-center gap-3">
                            <Key className="h-5 w-5" />
                            <div className="text-sm">
                                <strong>API Key Diperlukan:</strong> Untuk menggunakan fitur AI, harap masukkan Gemini API Key Anda di menu Pengaturan.
                            </div>
                            <Button size="sm" variant="outline" onClick={onOpenSettings} className="ml-auto bg-white border-yellow-300 hover:bg-yellow-100">Atur Key</Button>
                        </div>
                    )}

                    <Card className="min-h-[300px] border-purple-100 shadow-md">
                        <CardContent className="p-6">
                            {isLoading ? (
                                <div className="h-full flex flex-col items-center justify-center py-12 space-y-4 text-slate-400">
                                    <Loader2 className="h-12 w-12 animate-spin text-purple-500" />
                                    <p>Sedang menganalisis transaksi Anda...</p>
                                </div>
                            ) : advice ? (
                                <div className="prose prose-slate max-w-none">
                                    <div dangerouslySetInnerHTML={{ __html: md.render(advice) }} />
                                </div>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center py-12 space-y-4 text-slate-400 text-center">
                                    <div className="bg-purple-50 p-4 rounded-full">
                                        <Lightbulb className="h-8 w-8 text-purple-500" />
                                    </div>
                                    <div className="max-w-md">
                                        <h3 className="text-lg font-medium text-slate-900">Belum ada analisis</h3>
                                        <p>Klik tombol di atas untuk membiarkan AI membaca pola pengeluaran Anda dan memberikan saran penghematan.</p>
                                    </div>
                                </div>
                            )}
                        </CardContent>
                    </Card>

                    <div className="grid gap-4 md:grid-cols-3">
                        <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 border-purple-100">
                            <CardHeader>
                                <CardTitle className="text-base text-purple-900">Hemat Lebih Banyak</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <p className="text-sm text-purple-800">AI dapat mendeteksi langganan yang jarang digunakan atau kategori boros.</p>
                            </CardContent>
                        </Card>
                        <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 border-purple-100">
                            <CardHeader>
                                <CardTitle className="text-base text-purple-900">Capai Target</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <p className="text-sm text-purple-800">Dapatkan strategi realistis untuk mencapai target tabungan Anda lebih cepat.</p>
                            </CardContent>
                        </Card>
                        <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 border-purple-100">
                            <CardHeader>
                                <CardTitle className="text-base text-purple-900">Wawasan Instan</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <p className="text-sm text-purple-800">Tidak perlu menghitung manual, biarkan Sona AI merangkumnya untuk Anda.</p>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            );
        }

        // --- FEATURE COMPONENTS ---

        // 1. DASHBOARD
        function Dashboard({ transactions, budgets, goals }) {
            const totalIncome = transactions.filter(t => t.type === "income").reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === "expense").reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpenses;

            const categorySpending = transactions
                .filter(t => t.type === "expense")
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            const pieData = Object.entries(categorySpending).map(([name, value]) => ({ name, value }));
            const COLORS = ["#0088FE", "#00C49F", "#FFBB28", "#FF8042", "#8884d8", "#82ca9d"];

            // Mock monthly data
            const monthlyData = useMemo(() => Array.from({ length: 6 }, (_, i) => {
                const d = new Date();
                d.setMonth(d.getMonth() - (5 - i));
                return {
                    month: d.toLocaleString("id-ID", { month: "short" }),
                    income: Math.floor(Math.random() * 5000000) + 3000000,
                    expenses: Math.floor(Math.random() * 4000000) + 2000000,
                };
            }), []);

            return (
                <div className="space-y-6">
                    <div>
                        <h2 className="text-3xl font-bold tracking-tight">Ringkasan Keuangan</h2>
                        <p className="text-slate-500">Gambaran umum keuangan Anda</p>
                    </div>

                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                        <Card className="bg-gradient-to-br from-blue-500 to-blue-600 text-white border-0 shadow-lg">
                            <CardHeader className="flex flex-row items-center justify-between pb-2">
                                <CardTitle className="text-sm font-medium opacity-90">Saldo</CardTitle>
                                <WalletIcon className="h-4 w-4 opacity-90" />
                            </CardHeader>
                            <CardContent>
                                <div className="text-2xl font-bold">{formatIDR(balance)}</div>
                                <p className="text-xs opacity-80">{balance >= 0 ? "Keuangan sehat" : "Perlu perhatian"}</p>
                            </CardContent>
                        </Card>
                        <Card className="bg-gradient-to-br from-green-500 to-green-600 text-white border-0 shadow-lg">
                            <CardHeader className="flex flex-row items-center justify-between pb-2">
                                <CardTitle className="text-sm font-medium opacity-90">Pemasukan</CardTitle>
                                <TrendingUp className="h-4 w-4 opacity-90" />
                            </CardHeader>
                            <CardContent>
                                <div className="text-2xl font-bold">{formatIDR(totalIncome)}</div>
                            </CardContent>
                        </Card>
                        <Card className="bg-gradient-to-br from-red-500 to-red-600 text-white border-0 shadow-lg">
                            <CardHeader className="flex flex-row items-center justify-between pb-2">
                                <CardTitle className="text-sm font-medium opacity-90">Pengeluaran</CardTitle>
                                <TrendingDown className="h-4 w-4 opacity-90" />
                            </CardHeader>
                            <CardContent>
                                <div className="text-2xl font-bold">{formatIDR(totalExpenses)}</div>
                            </CardContent>
                        </Card>
                        <Card className="bg-gradient-to-br from-purple-500 to-purple-600 text-white border-0 shadow-lg">
                            <CardHeader className="flex flex-row items-center justify-between pb-2">
                                <CardTitle className="text-sm font-medium opacity-90">Target</CardTitle>
                                <Target className="h-4 w-4 opacity-90" />
                            </CardHeader>
                            <CardContent>
                                <div className="text-2xl font-bold">{goals.length}</div>
                                <p className="text-xs opacity-80">Target aktif</p>
                            </CardContent>
                        </Card>
                    </div>

                    <div className="grid gap-4 md:grid-cols-2">
                        <Card>
                            <CardHeader>
                                <CardTitle>Pengeluaran per Kategori</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="h-[300px] w-full">
                                    {pieData.length > 0 ? (
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie data={pieData} cx="50%" cy="50%" outerRadius={80} fill="#8884d8" dataKey="value" label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>
                                                    {pieData.map((entry, index) => (
                                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                    ))}
                                                </Pie>
                                                <RechartsTooltip formatter={(value) => formatIDR(value)} />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    ) : (
                                        <div className="flex items-center justify-center h-full text-slate-400">Belum ada data pengeluaran</div>
                                    )}
                                </div>
                            </CardContent>
                        </Card>
                        <Card>
                            <CardHeader>
                                <CardTitle>Tren Bulanan (Simulasi)</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="h-[300px] w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={monthlyData}>
                                            <CartesianGrid strokeDasharray="3 3" />
                                            <XAxis dataKey="month" />
                                            <YAxis tickFormatter={(val) => `${val/1000000}jt`} />
                                            <RechartsTooltip formatter={(value) => formatIDR(value)} />
                                            <Legend />
                                            <Line type="monotone" dataKey="income" stroke="#22c55e" name="Pemasukan" strokeWidth={2} />
                                            <Line type="monotone" dataKey="expenses" stroke="#ef4444" name="Pengeluaran" strokeWidth={2} />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            );
        }

        // 2. RECEIPT SCANNER (AI POWERED)
        function ReceiptScanner({ onScanComplete, categories, apiKey, onOpenSettings }) {
            const [isScanning, setIsScanning] = useState(false);
            
            const handleScan = async (e) => {
                if (!apiKey) {
                    toast.error("API Key belum diatur.");
                    onOpenSettings();
                    e.target.value = null; // reset
                    return;
                }

                const file = e.target.files?.[0];
                if (!file) return;
                
                setIsScanning(true);
                toast.info("Sedang memproses struk dengan AI...");

                try {
                    const model = getGeminiModel(apiKey);
                    if (!model) throw new Error("No model");

                    const imagePart = await fileToGenerativePart(file);
                    
                    const prompt = `
                        Analisis gambar struk belanja ini. Ekstrak informasi berikut dalam format JSON valid (tanpa markdown):
                        {
                            "amount": number (total bayar dalam angka, hilangkan 'Rp' atau titik/koma ribuan),
                            "description": string (nama toko atau merchant, gunakan Title Case),
                            "date": string (tanggal transaksi format YYYY-MM-DD, jika tidak ada gunakan hari ini),
                            "category": string (pilih satu yang paling relevan dari daftar ini: ${categories.join(", ")}, atau "Lainnya" jika tidak ada yang cocok)
                        }
                    `;

                    const result = await model.generateContent([prompt, imagePart]);
                    const text = result.response.text().replace(/```json|```/g, "").trim();
                    const data = JSON.parse(text);

                    // Validate data
                    const amount = parseFloat(data.amount) || 0;
                    const desc = data.description || "Struk Belanja";
                    const cat = categories.includes(data.category) ? data.category : "Lainnya";
                    const date = data.date || new Date().toISOString().split("T")[0];

                    onScanComplete(amount, desc, cat, date);
                    
                } catch (error) {
                    console.error("Scan Error:", error);
                    toast.error("Gagal memindai struk. Pastikan API Key benar dan gambar jelas.");
                } finally {
                    setIsScanning(false);
                    // Reset file input
                    e.target.value = null;
                }
            };

            return (
                <Card className="border-2 border-dashed border-slate-200 bg-slate-50 overflow-hidden relative">
                    {isScanning && (
                         <div className="absolute inset-0 bg-white/80 z-10 flex items-center justify-center flex-col gap-2 backdrop-blur-sm">
                            <Loader2 className="h-8 w-8 animate-spin text-purple-600" />
                            <p className="text-sm font-medium text-purple-700 animate-pulse">Gemini sedang membaca struk...</p>
                        </div>
                    )}
                    <CardContent className="p-6 flex flex-col items-center text-center space-y-4">
                        <div className="rounded-full bg-white p-4 shadow-sm relative group">
                            <div className="absolute inset-0 bg-purple-100 rounded-full scale-0 group-hover:scale-110 transition-transform duration-300"></div>
                            <Camera className="h-8 w-8 text-purple-600 relative z-10" />
                        </div>
                        <div>
                            <h3 className="font-semibold text-slate-900">AI Scan Struk</h3>
                            <p className="text-sm text-slate-500 mt-1">Upload foto struk, biarkan AI mengisi data.</p>
                        </div>
                        <div className="relative w-full max-w-xs mx-auto">
                            <input type="file" accept="image/*" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" onChange={handleScan} disabled={isScanning} />
                            <Button disabled={isScanning} className="w-full bg-white text-slate-900 border hover:bg-slate-50">
                                Pilih Foto
                            </Button>
                        </div>
                        {!apiKey && <p className="text-xs text-red-500">*Butuh API Key</p>}
                    </CardContent>
                </Card>
            );
        }

        // 3. TRANSACTIONS
        function Transactions({ transactions, wallets, onAddTransaction, onDeleteTransaction, categories, apiKey, onOpenSettings }) {
            const [isOpen, setIsOpen] = useState(false);
            const [type, setType] = useState("expense");
            const [amount, setAmount] = useState("");
            const [category, setCategory] = useState(categories[0]);
            const [description, setDescription] = useState("");
            const [date, setDate] = useState(new Date().toISOString().split("T")[0]);
            const [walletId, setWalletId] = useState(wallets[0]?.id || "");
            const [filterType, setFilterType] = useState("all");
            
            // AI Smart Input State
            const [smartInput, setSmartInput] = useState("");
            const [isSmartProcessing, setIsSmartProcessing] = useState(false);

            const handleSmartProcess = async () => {
                if (!smartInput.trim()) return;
                
                if (!apiKey) {
                    toast.error("API Key belum diatur.");
                    onOpenSettings();
                    return;
                }

                setIsSmartProcessing(true);
                try {
                    const model = getGeminiModel(apiKey);
                    if (!model) throw new Error("No model");

                    const prompt = `
                        Extract transaction details from this text: '${smartInput}'. 
                        Return JSON string only (no markdown) with keys: 
                        - amount (number, clean without currency symbols)
                        - category (best match from: ${categories.join(', ')} or 'Lainnya')
                        - description (string, capitalized)
                        
                        Example input: "Makan bakso 15rb" -> {"amount": 15000, "category": "Makanan & Minuman", "description": "Makan Bakso"}
                    `;
                    const result = await model.generateContent(prompt);
                    const text = result.response.text().replace(/```json|```/g, "").trim();
                    const data = JSON.parse(text);
                    
                    if (data.amount) setAmount(data.amount);
                    if (data.category) setCategory(data.category);
                    if (data.description) setDescription(data.description);
                    
                    setSmartInput("");
                    toast.success("Data diisi otomatis oleh AI! ✨");
                } catch (e) {
                    console.error(e);
                    toast.error("Gagal memproses input pintar. Cek API Key.");
                } finally {
                    setIsSmartProcessing(false);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount || !description || !walletId) return;
                onAddTransaction({ type, amount: parseFloat(amount), category, description, date, walletId });
                setAmount(""); setDescription(""); setIsOpen(false);
            };

            const handleScanResult = (scannedAmount, scannedDesc, scannedCat, scannedDate) => {
                setAmount(scannedAmount);
                setDescription(scannedDesc);
                setCategory(scannedCat);
                if(scannedDate) setDate(scannedDate);
                setType("expense");
                setIsOpen(true);
                toast.success("Struk berhasil dipindai! Silakan cek kembali.");
            };

            const filtered = transactions
                .filter(t => filterType === "all" || t.type === filterType)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-3xl font-bold tracking-tight">Transaksi</h2>
                            <p className="text-slate-500">Lacak pemasukan dan pengeluaran</p>
                        </div>
                        <Button onClick={() => setIsOpen(true)} className="bg-gradient-to-r from-blue-600 to-purple-600 border-0">
                            <Plus className="mr-2 h-4 w-4" /> Tambah
                        </Button>
                    </div>

                    <ReceiptScanner onScanComplete={handleScanResult} categories={categories} apiKey={apiKey} onOpenSettings={onOpenSettings} />

                    <div className="flex gap-4 mb-4 overflow-x-auto pb-2">
                         <Button variant={filterType === "all" ? "default" : "outline"} onClick={() => setFilterType("all")} size="sm">Semua</Button>
                         <Button variant={filterType === "income" ? "default" : "outline"} onClick={() => setFilterType("income")} size="sm">Pemasukan</Button>
                         <Button variant={filterType === "expense" ? "default" : "outline"} onClick={() => setFilterType("expense")} size="sm">Pengeluaran</Button>
                    </div>

                    <div className="space-y-3">
                        {filtered.length > 0 ? filtered.map((t) => {
                            const wallet = wallets.find(w => w.id === t.walletId);
                            return (
                                <Card key={t.id} className="hover:shadow-md transition-shadow">
                                    <CardContent className="p-4 flex items-center justify-between">
                                        <div className="flex items-center gap-3 overflow-hidden">
                                            <div className={cn("p-2.5 rounded-xl flex-shrink-0", t.type === "income" ? "bg-green-100 text-green-600" : "bg-red-100 text-red-600")}>
                                                {t.type === "income" ? <ArrowDownCircle className="h-5 w-5" /> : <ArrowUpCircle className="h-5 w-5" />}
                                            </div>
                                            <div className="min-w-0">
                                                <h4 className="font-semibold truncate">{t.description}</h4>
                                                <div className="flex items-center gap-2 text-xs text-slate-500 mt-1">
                                                    <Badge variant="secondary" className="text-[10px] h-5">{t.category}</Badge>
                                                    <span>• {new Date(t.date).toLocaleDateString("id-ID")}</span>
                                                    {wallet && <span>• {wallet.name}</span>}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3 flex-shrink-0 ml-2">
                                            <span className={cn("font-bold whitespace-nowrap", t.type === "income" ? "text-green-600" : "text-red-600")}>
                                                {t.type === "income" ? "+" : "-"}{formatIDR(t.amount)}
                                            </span>
                                            <Button variant="ghost" size="icon" className="h-8 w-8 text-red-500 hover:text-red-700 hover:bg-red-50" onClick={() => onDeleteTransaction(t.id)}>
                                                <Trash2 className="h-4 w-4" />
                                            </Button>
                                        </div>
                                    </CardContent>
                                </Card>
                            )
                        }) : (
                            <div className="text-center py-12 text-slate-500">Belum ada transaksi.</div>
                        )}
                    </div>

                    <Dialog open={isOpen} onOpenChange={setIsOpen}>
                        <div className="space-y-4">
                            <h2 className="text-lg font-semibold">Tambah Transaksi</h2>
                            
                            {/* AI Smart Input */}
                            <div className="bg-gradient-to-r from-purple-50 to-indigo-50 p-3 rounded-lg border border-purple-100 mb-4">
                                <Label className="text-purple-700 flex items-center gap-2 mb-2"><Sparkles className="h-3 w-3" /> Input Cerdas AI</Label>
                                <div className="flex gap-2">
                                    <Input 
                                        value={smartInput} 
                                        onChange={(e) => setSmartInput(e.target.value)} 
                                        placeholder="Contoh: 'Beli kopi 25rb'" 
                                        className="bg-white"
                                        onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), handleSmartProcess())}
                                    />
                                    <Button 
                                        type="button" 
                                        onClick={handleSmartProcess} 
                                        disabled={isSmartProcessing || !smartInput}
                                        className="bg-purple-600 hover:bg-purple-700 text-white"
                                    >
                                        {isSmartProcessing ? <Loader2 className="h-4 w-4 animate-spin" /> : <Sparkles className="h-4 w-4" />}
                                    </Button>
                                </div>
                                <p className="text-[10px] text-purple-600/70 mt-1">
                                    {!apiKey ? <span className="text-red-500">API Key belum diatur!</span> : "Ketik transaksi Anda dan biarkan AI mengisinya untuk Anda."}
                                </p>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="flex gap-2">
                                    <Button type="button" className={cn("flex-1", type === "expense" ? "bg-red-600 hover:bg-red-700 text-white" : "bg-white text-slate-900 border")} onClick={() => setType("expense")}>Pengeluaran</Button>
                                    <Button type="button" className={cn("flex-1", type === "income" ? "bg-green-600 hover:bg-green-700 text-white" : "bg-white text-slate-900 border")} onClick={() => setType("income")}>Pemasukan</Button>
                                </div>
                                <div>
                                    <Label>Dompet</Label>
                                    <Select value={walletId} onValueChange={setWalletId}>
                                        {wallets.map(w => <SelectItem key={w.id} value={w.id}>{w.name}</SelectItem>)}
                                    </Select>
                                </div>
                                <div>
                                    <Label>Jumlah</Label>
                                    <Input type="number" value={amount} onChange={e => setAmount(e.target.value)} placeholder="0" required />
                                </div>
                                <div>
                                    <Label>Kategori</Label>
                                    <Select value={category} onValueChange={setCategory}>
                                        {categories.map(c => <SelectItem key={c} value={c}>{c}</SelectItem>)}
                                    </Select>
                                </div>
                                <div>
                                    <Label>Keterangan</Label>
                                    <Input value={description} onChange={e => setDescription(e.target.value)} placeholder="Makan siang..." required />
                                </div>
                                <div>
                                    <Label>Tanggal</Label>
                                    <Input type="date" value={date} onChange={e => setDate(e.target.value)} required />
                                </div>
                                <Button type="submit" className="w-full bg-blue-600 hover:bg-blue-700">Simpan</Button>
                            </form>
                        </div>
                    </Dialog>
                </div>
            );
        }

        // 4. WALLETS
        function Wallets({ wallets, transactions, onAddWallet, onDeleteWallet }) {
            const [isOpen, setIsOpen] = useState(false);
            const [name, setName] = useState("");
            const [balance, setBalance] = useState("");
            const [color, setColor] = useState("bg-blue-500");

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name) return;
                onAddWallet({ name, balance: parseFloat(balance) || 0, color, icon: "wallet" });
                setIsOpen(false); setName(""); setBalance("");
            };

            const getBalance = (w) => {
                const txs = transactions.filter(t => t.walletId === w.id);
                const inc = txs.filter(t => t.type === "income").reduce((s, t) => s + t.amount, 0);
                const exp = txs.filter(t => t.type === "expense").reduce((s, t) => s + t.amount, 0);
                return w.balance + inc - exp;
            };

            const COLORS = ["bg-blue-500", "bg-green-500", "bg-orange-500", "bg-purple-500", "bg-pink-500", "bg-slate-800"];

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-3xl font-bold tracking-tight">Dompet Saya</h2>
                            <p className="text-slate-500">Kelola sumber dana Anda</p>
                        </div>
                        <Button onClick={() => setIsOpen(true)} className="bg-gradient-to-r from-blue-600 to-purple-600 border-0">
                            <Plus className="mr-2 h-4 w-4" /> Tambah
                        </Button>
                    </div>

                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        {wallets.map(w => (
                            <Card key={w.id} className={cn("text-white border-0 shadow-lg relative overflow-hidden", w.color)}>
                                <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 pointer-events-none"></div>
                                <CardHeader className="pb-2 relative z-10">
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <WalletIcon className="h-5 w-5" />
                                            <CardTitle className="text-lg">{w.name}</CardTitle>
                                        </div>
                                        <button onClick={() => onDeleteWallet(w.id)} className="text-white/70 hover:text-white"><Trash2 className="h-4 w-4"/></button>
                                    </div>
                                </CardHeader>
                                <CardContent className="relative z-10">
                                    <p className="text-sm opacity-80">Saldo Saat Ini</p>
                                    <p className="text-3xl font-bold mt-1">{formatIDR(getBalance(w))}</p>
                                    <p className="text-xs opacity-60 mt-4 border-t border-white/20 pt-2">Saldo Awal: {formatIDR(w.balance)}</p>
                                </CardContent>
                            </Card>
                        ))}
                    </div>

                    <Dialog open={isOpen} onOpenChange={setIsOpen}>
                        <div className="space-y-4">
                            <h2 className="text-lg font-semibold">Tambah Dompet</h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <Label>Nama Dompet</Label>
                                    <Input value={name} onChange={e => setName(e.target.value)} placeholder="e.g. BCA, GoPay" required />
                                </div>
                                <div>
                                    <Label>Saldo Awal</Label>
                                    <Input type="number" value={balance} onChange={e => setBalance(e.target.value)} placeholder="0" />
                                </div>
                                <div>
                                    <Label>Warna Kartu</Label>
                                    <div className="flex gap-2 mt-2">
                                        {COLORS.map(c => (
                                            <button key={c} type="button" className={cn("w-6 h-6 rounded-full", c, color === c && "ring-2 ring-offset-2 ring-slate-900")} onClick={() => setColor(c)} />
                                        ))}
                                    </div>
                                </div>
                                <Button type="submit" className="w-full bg-blue-600">Simpan</Button>
                            </form>
                        </div>
                    </Dialog>
                </div>
            );
        }

        // 5. BUDGETS
        function Budgets({ budgets, onAddBudget, onDeleteBudget, categories }) {
            const [isOpen, setIsOpen] = useState(false);
            const [category, setCategory] = useState("");
            const [limit, setLimit] = useState("");

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!category || !limit) return;
                onAddBudget({ category, limit: parseFloat(limit), color: "#3b82f6" });
                setIsOpen(false); setCategory(""); setLimit("");
            };

            const availCats = categories.filter(c => !budgets.find(b => b.category === c));

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-3xl font-bold tracking-tight">Anggaran</h2>
                            <p className="text-slate-500">Batasi pengeluaran bulanan</p>
                        </div>
                        <Button onClick={() => setIsOpen(true)} className="bg-gradient-to-r from-blue-600 to-purple-600 border-0" disabled={availCats.length === 0}>
                            <Plus className="mr-2 h-4 w-4" /> Buat Anggaran
                        </Button>
                    </div>

                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        {budgets.map(b => {
                            const pct = (b.spent / b.limit) * 100;
                            const isOver = pct > 100;
                            return (
                                <Card key={b.id}>
                                    <CardHeader className="pb-2">
                                        <div className="flex justify-between items-center gap-2">
                                            <CardTitle className="text-lg truncate">{b.category}</CardTitle>
                                            <button onClick={() => onDeleteBudget(b.id)} className="text-slate-400 hover:text-red-500 shrink-0"><Trash2 className="h-4 w-4"/></button>
                                        </div>
                                    </CardHeader>
                                    <CardContent className="space-y-4 pt-2">
                                        <div className="flex justify-between text-sm">
                                            <span className="text-slate-500">Terpakai: {formatIDR(b.spent)}</span>
                                            <span className="font-medium">Batas: {formatIDR(b.limit)}</span>
                                        </div>
                                        <Progress value={Math.min(pct, 100)} className={cn("h-2", isOver ? "bg-red-100" : "bg-slate-100")} />
                                        <div className="flex items-center gap-2 text-sm">
                                            {isOver ? <AlertCircle className="h-4 w-4 text-red-500 shrink-0" /> : <CheckCircle className="h-4 w-4 text-green-500 shrink-0" />}
                                            <span className={isOver ? "text-red-600 truncate" : "text-green-600 truncate"}>
                                                {isOver ? `Over budget (${pct.toFixed(0)}%)` : `Sisa ${formatIDR(b.limit - b.spent)}`}
                                            </span>
                                        </div>
                                    </CardContent>
                                </Card>
                            )
                        })}
                    </div>
                    
                    <Dialog open={isOpen} onOpenChange={setIsOpen}>
                        <div className="space-y-4">
                            <h2 className="text-lg font-semibold">Buat Anggaran</h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <Label>Kategori</Label>
                                    <Select value={category} onValueChange={setCategory}>
                                        <SelectItem value="">Pilih Kategori</SelectItem>
                                        {availCats.map(c => <SelectItem key={c} value={c}>{c}</SelectItem>)}
                                    </Select>
                                </div>
                                <div>
                                    <Label>Batas Bulanan (Rp)</Label>
                                    <Input type="number" value={limit} onChange={e => setLimit(e.target.value)} required />
                                </div>
                                <Button type="submit" className="w-full bg-blue-600">Simpan</Button>
                            </form>
                        </div>
                    </Dialog>
                </div>
            );
        }

        // 6. GOALS
        function Goals({ goals, onAddGoal, onUpdateGoal, onDeleteGoal }) {
            const [isOpen, setIsOpen] = useState(false);
            const [contribOpen, setContribOpen] = useState(false);
            const [selectedGoal, setSelectedGoal] = useState(null);
            const [name, setName] = useState("");
            const [target, setTarget] = useState("");
            const [contrib, setContrib] = useState("");
            const [deadline, setDeadline] = useState("");

            const handleAdd = (e) => {
                e.preventDefault();
                onAddGoal({ name, targetAmount: parseFloat(target), deadline });
                setIsOpen(false); setName(""); setTarget(""); setDeadline("");
            };

            const handleContrib = (e) => {
                e.preventDefault();
                if(selectedGoal) {
                    onUpdateGoal(selectedGoal.id, selectedGoal.currentAmount + parseFloat(contrib));
                    setContribOpen(false); setContrib(""); setSelectedGoal(null);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-3xl font-bold tracking-tight">Target Keuangan</h2>
                            <p className="text-slate-500">Wujudkan impian finansial Anda</p>
                        </div>
                        <Button onClick={() => setIsOpen(true)} className="bg-gradient-to-r from-blue-600 to-purple-600 border-0">
                            <Plus className="mr-2 h-4 w-4" /> Tambah Target
                        </Button>
                    </div>

                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        {goals.map(g => {
                            const pct = (g.currentAmount / g.targetAmount) * 100;
                            const isDone = pct >= 100;
                            return (
                                <Card key={g.id} className="relative overflow-hidden">
                                    {isDone && <div className="absolute top-0 left-0 right-0 h-1 bg-green-500"></div>}
                                    <CardHeader className="flex flex-row items-start justify-between pb-2 gap-2">
                                        <div className="flex-1 min-w-0">
                                            <CardTitle className="text-lg truncate">{g.name}</CardTitle>
                                            <p className="text-xs text-slate-500 mt-1">Target: {formatIDR(g.targetAmount)}</p>
                                        </div>
                                        <button onClick={() => onDeleteGoal(g.id)} className="text-slate-400 hover:text-red-500 shrink-0"><Trash2 className="h-4 w-4"/></button>
                                    </CardHeader>
                                    <CardContent className="space-y-4">
                                        <div className="flex justify-between items-end">
                                            <span className="text-2xl font-bold">{formatIDR(g.currentAmount)}</span>
                                            <span className="text-sm text-slate-500 mb-1">{pct.toFixed(0)}%</span>
                                        </div>
                                        <Progress value={Math.min(pct, 100)} className={cn("h-2", isDone && "bg-green-100")} />
                                        
                                        {!isDone && (
                                            <Button variant="outline" className="w-full text-xs h-8" onClick={() => { setSelectedGoal(g); setContribOpen(true); }}>
                                                <TrendingUp className="mr-2 h-3 w-3" /> Tambah Tabungan
                                            </Button>
                                        )}
                                        {isDone && <div className="text-center text-sm text-green-600 font-medium py-1 bg-green-50 rounded">Tercapai! 🎉</div>}
                                    </CardContent>
                                </Card>
                            );
                        })}
                    </div>

                    <Dialog open={isOpen} onOpenChange={setIsOpen}>
                        <div className="space-y-4">
                            <h2 className="text-lg font-semibold">Target Baru</h2>
                            <form onSubmit={handleAdd} className="space-y-4">
                                <div><Label>Nama Target</Label><Input value={name} onChange={e => setName(e.target.value)} placeholder="Liburan, Gadget..." required /></div>
                                <div><Label>Nominal Target</Label><Input type="number" value={target} onChange={e => setTarget(e.target.value)} required /></div>
                                <div><Label>Tenggat Waktu</Label><Input type="date" value={deadline} onChange={e => setDeadline(e.target.value)} required /></div>
                                <Button type="submit" className="w-full bg-blue-600">Buat Target</Button>
                            </form>
                        </div>
                    </Dialog>

                    <Dialog open={contribOpen} onOpenChange={setContribOpen}>
                         <div className="space-y-4">
                            <h2 className="text-lg font-semibold">Nabung untuk {selectedGoal?.name}</h2>
                            <form onSubmit={handleContrib} className="space-y-4">
                                <div><Label>Jumlah (Rp)</Label><Input type="number" value={contrib} onChange={e => setContrib(e.target.value)} required /></div>
                                <Button type="submit" className="w-full bg-green-600">Simpan</Button>
                            </form>
                        </div>
                    </Dialog>
                </div>
            );
        }

        // --- MAIN APP COMPONENT ---
        const CATEGORIES = ["Makanan & Minuman", "Transportasi", "Belanja", "Hiburan", "Tagihan", "Kesehatan", "Pendidikan", "Gaji", "Investasi", "Lainnya"];

        function App() {
            const [activeTab, setActiveTab] = useState("dashboard");
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const fileInputRef = useRef(null);
            
            // STATE
            const [wallets, setWallets] = useState(() => {
                const s = localStorage.getItem("sona-wallets");
                return s ? JSON.parse(s) : [{ id: "w1", name: "Dompet Tunai", balance: 0, color: "bg-orange-500", icon: "cash" }];
            });
            const [transactions, setTransactions] = useState(() => {
                const s = localStorage.getItem("sona-transactions");
                return s ? JSON.parse(s) : [];
            });
            const [budgets, setBudgets] = useState(() => {
                const s = localStorage.getItem("sona-budgets");
                return s ? JSON.parse(s) : [];
            });
            const [goals, setGoals] = useState(() => {
                const s = localStorage.getItem("sona-goals");
                return s ? JSON.parse(s) : [];
            });
            const [apiKey, setApiKey] = useState(() => {
                return localStorage.getItem("sona_api_key") || "";
            });

            // PERSISTENCE
            useEffect(() => localStorage.setItem("sona-wallets", JSON.stringify(wallets)), [wallets]);
            useEffect(() => localStorage.setItem("sona-transactions", JSON.stringify(transactions)), [transactions]);
            useEffect(() => localStorage.setItem("sona-budgets", JSON.stringify(budgets)), [budgets]);
            useEffect(() => localStorage.setItem("sona-goals", JSON.stringify(goals)), [goals]);
            useEffect(() => localStorage.setItem("sona_api_key", apiKey), [apiKey]);

            // ACTIONS
            const addTx = (t) => {
                setTransactions(prev => [...prev, { ...t, id: Date.now().toString() }]);
                if(t.type === 'expense') {
                    setBudgets(prev => prev.map(b => b.category === t.category ? { ...b, spent: b.spent + t.amount } : b));
                }
                toast.success("Transaksi berhasil");
            };
            const delTx = (id) => {
                const t = transactions.find(tx => tx.id === id);
                if(t && t.type === 'expense') {
                    setBudgets(prev => prev.map(b => b.category === t.category ? { ...b, spent: Math.max(0, b.spent - t.amount) } : b));
                }
                setTransactions(prev => prev.filter(tx => tx.id !== id));
                toast.success("Dihapus");
            };
            const addWallet = (w) => { setWallets(prev => [...prev, { ...w, id: "w"+Date.now() }]); toast.success("Dompet dibuat"); };
            const delWallet = (id) => {
                if(transactions.some(t => t.walletId === id)) return toast.error("Dompet ada transaksi!");
                setWallets(prev => prev.filter(w => w.id !== id));
                toast.success("Dompet dihapus");
            };
            const addBudget = (b) => {
                const spent = transactions.filter(t => t.type === 'expense' && t.category === b.category).reduce((s,t) => s + t.amount, 0);
                setBudgets(prev => [...prev, { ...b, id: Date.now().toString(), spent }]);
                toast.success("Anggaran dibuat");
            };
            const delBudget = (id) => { setBudgets(prev => prev.filter(b => b.id !== id)); toast.success("Anggaran dihapus"); };
            const addGoal = (g) => { setGoals(prev => [...prev, { ...g, id: Date.now().toString(), currentAmount: 0 }]); toast.success("Target dibuat"); };
            const updateGoal = (id, amt) => { setGoals(prev => prev.map(g => g.id === id ? { ...g, currentAmount: amt } : g)); toast.success("Berhasil menabung!"); };
            const delGoal = (id) => { setGoals(prev => prev.filter(g => g.id !== id)); toast.success("Target dihapus"); };

            // --- DATA IMPORT/EXPORT ---
            const handleExport = () => {
                const data = {
                    version: 1,
                    timestamp: new Date().toISOString(),
                    data: { transactions, wallets, budgets, goals }
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sona-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                toast.success("Data berhasil didownload!");
            };

            const handleImportClick = () => fileInputRef.current?.click();

            const handleImportFile = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const parsed = JSON.parse(ev.target.result);
                        if (!parsed.data || !parsed.data.transactions) throw new Error("Format invalid");
                        
                        // Basic validation passed, ask for confirmation or just do it
                        if(confirm("Apakah Anda yakin ingin me-restore data? Data saat ini akan ditimpa/digabung.")) {
                            setTransactions(parsed.data.transactions || []);
                            setWallets(parsed.data.wallets || []);
                            setBudgets(parsed.data.budgets || []);
                            setGoals(parsed.data.goals || []);
                            toast.success("Data berhasil direstore!");
                        }
                    } catch (err) {
                        toast.error("Gagal membaca file backup.");
                        console.error(err);
                    }
                };
                reader.readAsText(file);
                e.target.value = null; // reset
            };

            const renderContent = () => {
                switch(activeTab) {
                    case "dashboard": return <Dashboard transactions={transactions} budgets={budgets} goals={goals} />;
                    case "transactions": return <Transactions transactions={transactions} wallets={wallets} onAddTransaction={addTx} onDeleteTransaction={delTx} categories={CATEGORIES} apiKey={apiKey} onOpenSettings={() => setIsSettingsOpen(true)} />;
                    case "wallets": return <Wallets wallets={wallets} transactions={transactions} onAddWallet={addWallet} onDeleteWallet={delWallet} />;
                    case "budgets": return <Budgets budgets={budgets} onAddBudget={addBudget} onDeleteBudget={delBudget} categories={CATEGORIES} />;
                    case "goals": return <Goals goals={goals} onAddGoal={addGoal} onUpdateGoal={updateGoal} onDeleteGoal={delGoal} />;
                    case "ai-advisor": return <AIAdvisor transactions={transactions} budgets={budgets} goals={goals} apiKey={apiKey} onOpenSettings={() => setIsSettingsOpen(true)} />;
                    default: return null;
                }
            };

            const NavItem = ({ id, label, icon: Icon, isAi }) => (
                <button
                    onClick={() => { setActiveTab(id); setIsMobileMenuOpen(false); }}
                    className={cn(
                        "w-full flex items-center gap-4 px-5 py-3 rounded-xl transition-all duration-200 group relative",
                        activeTab === id 
                            ? (isAi ? "bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-md" : "bg-slate-900 text-white shadow-md") 
                            : "text-slate-600 hover:bg-slate-100"
                    )}
                >
                    <Icon className={cn("h-5 w-5", isAi && activeTab !== id && "text-purple-600")} />
                    <span className="font-medium">{label}</span>
                    {isAi && <span className="absolute right-4 top-1/2 -translate-y-1/2 flex h-2 w-2">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-purple-400 opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-2 w-2 bg-purple-500"></span>
                    </span>}
                </button>
            );

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-50">
                    <Toaster richColors position="top-center" />
                    <SettingsDialog isOpen={isSettingsOpen} onOpenChange={setIsSettingsOpen} apiKey={apiKey} setApiKey={setApiKey} />
                    
                    {/* Hidden Input for Import */}
                    <input type="file" ref={fileInputRef} onChange={handleImportFile} accept=".json" className="hidden" />

                    {/* Desktop Sidebar */}
                    <aside className="hidden lg:flex lg:flex-col lg:w-72 bg-white border-r h-screen sticky top-0">
                        <div className="p-6 border-b flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">/Sona</h1>
                                <p className="text-xs text-slate-500 mt-1">Personal Finance</p>
                            </div>
                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500">
                                <Settings className="h-5 w-5" />
                            </button>
                        </div>
                        <nav className="flex-1 p-4 space-y-1">
                            <NavItem id="dashboard" label="Beranda" icon={LayoutDashboard} />
                            <NavItem id="transactions" label="Transaksi" icon={Receipt} />
                            <NavItem id="wallets" label="Dompet" icon={WalletIcon} />
                            <NavItem id="budgets" label="Anggaran" icon={PiggyBank} />
                            <NavItem id="goals" label="Target" icon={Target} />
                            <div className="pt-4 mt-4 border-t border-slate-100">
                                <p className="px-5 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Smart Features</p>
                                <NavItem id="ai-advisor" label="AI Advisor" icon={Sparkles} isAi={true} />
                            </div>
                        </nav>
                        
                        {/* Desktop Backup/Restore */}
                        <div className="p-4 border-t space-y-2">
                            <p className="px-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Data Management</p>
                            <button onClick={handleExport} className="w-full flex items-center gap-3 px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">
                                <Download className="h-4 w-4" /> Backup Data (JSON)
                            </button>
                            <button onClick={handleImportClick} className="w-full flex items-center gap-3 px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">
                                <Upload className="h-4 w-4" /> Restore Data
                            </button>
                        </div>

                        <div className="p-4 text-xs text-slate-400 text-center border-t">
                            © 2024 Sona Finance
                        </div>
                    </aside>

                    {/* Mobile Header */}
                    <header className="lg:hidden bg-white border-b p-4 sticky top-0 z-20 flex items-center justify-between shadow-sm">
                         <div>
                            <h1 className="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">/Sona</h1>
                        </div>
                        <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="p-2 text-slate-600">
                            {isMobileMenuOpen ? <X /> : <Menu />}
                        </button>
                    </header>

                    {/* Mobile Menu Overlay */}
                    {isMobileMenuOpen && (
                        <div className="lg:hidden fixed inset-0 z-10 bg-white pt-20 px-4 flex flex-col h-screen">
                            <div className="flex-1 space-y-2 overflow-y-auto">
                                <NavItem id="dashboard" label="Beranda" icon={LayoutDashboard} />
                                <NavItem id="transactions" label="Transaksi" icon={Receipt} />
                                <NavItem id="wallets" label="Dompet" icon={WalletIcon} />
                                <NavItem id="budgets" label="Anggaran" icon={PiggyBank} />
                                <NavItem id="goals" label="Target" icon={Target} />
                                <div className="border-t my-2 pt-2"></div>
                                <NavItem id="ai-advisor" label="AI Advisor" icon={Sparkles} isAi={true} />
                                
                                <div className="border-t my-4 pt-4">
                                    <p className="px-2 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Settings</p>
                                    <button onClick={() => { setIsSettingsOpen(true); setIsMobileMenuOpen(false); }} className="w-full flex items-center gap-4 px-5 py-3 text-slate-600 hover:bg-slate-100 rounded-xl">
                                        <Settings className="h-5 w-5" /> Pengaturan API
                                    </button>
                                </div>

                                <div className="border-t my-4 pt-4">
                                    <p className="px-2 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Data Management</p>
                                    <button onClick={() => { handleExport(); setIsMobileMenuOpen(false); }} className="w-full flex items-center gap-4 px-5 py-3 text-slate-600 hover:bg-slate-100 rounded-xl">
                                        <Download className="h-5 w-5" /> Backup Data
                                    </button>
                                    <button onClick={() => { handleImportClick(); setIsMobileMenuOpen(false); }} className="w-full flex items-center gap-4 px-5 py-3 text-slate-600 hover:bg-slate-100 rounded-xl">
                                        <Upload className="h-5 w-5" /> Restore Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="flex-1 p-4 lg:p-8 max-w-7xl mx-auto w-full pb-24 lg:pb-8">
                        {renderContent()}
                    </main>

                    {/* Mobile Bottom Nav */}
                    <nav className="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t p-2 z-20 shadow-[0_-5px_10px_rgba(0,0,0,0.05)]">
                        <div className="grid grid-cols-5 gap-1">
                            {[
                                { id: "dashboard", icon: LayoutDashboard, label: "Home" },
                                { id: "transactions", icon: Receipt, label: "Trans" },
                                { id: "wallets", icon: WalletIcon, label: "Wallet" },
                                { id: "budgets", icon: PiggyBank, label: "Budget" },
                                { id: "goals", icon: Target, label: "Goal" },
                            ].map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)} 
                                    className={cn("flex flex-col items-center p-2 rounded-lg", activeTab === item.id ? "text-blue-600 bg-blue-50" : "text-slate-400")}
                                >
                                    <item.icon className="h-5 w-5" />
                                    <span className="text-[10px] font-medium mt-1">{item.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
