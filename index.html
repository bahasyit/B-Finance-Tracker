<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Sona - Financial Planner with AI</title>
    
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sona">
    
    <!-- Icon Aplikasi -->
    <link rel="apple-touch-icon" href="Sona.png">
    <link rel="icon" href="Sona.png" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & Libraries via Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "lucide-react": "https://esm.sh/lucide-react@0.378.0?deps=react@18.3.1",
        "recharts": "https://esm.sh/recharts@2.12.7?deps=react@18.3.1,react-dom@18.3.1",
        "clsx": "https://esm.sh/clsx",
        "tailwind-merge": "https://esm.sh/tailwind-merge",
        "sonner": "https://esm.sh/sonner@1.4.41?deps=react@18.3.1,react-dom@18.3.1",
        "@google/generative-ai": "https://esm.sh/@google/generative-ai",
        "html2canvas": "https://esm.sh/html2canvas@1.4.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>

    <style>
        :root {
            --font-sans: 'Inter', sans-serif;
            --background: #ffffff;
            --foreground: #020817;
            --primary: #0f172a;
            --primary-foreground: #f8fafc;
        }
        
        body {
            font-family: var(--font-sans);
            background-color: #f8fafc;
            color: var(--foreground);
            overscroll-behavior-y: none; /* Prevent bounce scrolling */
            overflow-x: hidden; /* Prevent horizontal scroll on body */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Markdown Styles */
        .prose h3 { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { color: #0f172a; font-weight: 600; }
        .prose p { margin-bottom: 0.75em; line-height: 1.6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import { 
            LayoutDashboard, Receipt, Wallet as WalletIcon, PiggyBank, Target, 
            Plus, Trash2, ArrowUpCircle, ArrowDownCircle, Filter, CreditCard, 
            Banknote, TrendingUp, TrendingDown, Calendar as CalendarIcon, 
            CheckCircle, AlertCircle, X, Menu, Camera, Loader2, ChevronDown, 
            Sparkles, Bot, Lightbulb, Download, Upload, Settings, Key, 
            Eye, EyeOff, LineChart, History, ArrowRight, Users, Calculator,
            UserPlus, Check, Share2, Image as ImageIcon, ChevronLeft
        } from 'lucide-react';
        import { 
            PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip as RechartsTooltip, 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, LineChart as RechartsLineChart, Line, ReferenceLine
        } from 'recharts';
        import { Toaster, toast } from 'sonner';
        import { clsx } from 'clsx';
        import { twMerge } from 'tailwind-merge';
        import html2canvas from 'html2canvas';

        // --- UTILS & HELPERS ---
        function cn(...inputs) { return twMerge(clsx(inputs)); }

        function formatIDR(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(amount);
        }

        // Helper untuk privasi (Sembunyikan Uang)
        const displayMoney = (amount, isPrivacy) => isPrivacy ? "••••••" : formatIDR(amount);

        function getGeminiModel(apiKey) {
            if (!apiKey) return null;
            const genAI = new GoogleGenerativeAI(apiKey);
            return genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
        }

        async function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve({
                    inlineData: { data: reader.result.split(",")[1], mimeType: file.type },
                });
                reader.readAsDataURL(file);
            });
        }

        // --- UI COMPONENTS ---
        const Button = React.forwardRef(({ className, variant = "default", size = "default", ...props }, ref) => {
            const variants = {
                default: "bg-slate-900 text-white hover:bg-slate-900/90",
                destructive: "bg-red-500 text-white hover:bg-red-500/90",
                outline: "border border-slate-200 bg-white hover:bg-slate-100 text-slate-900",
                secondary: "bg-slate-100 text-slate-900 hover:bg-slate-100/80",
                ghost: "hover:bg-slate-100 hover:text-slate-900",
                link: "text-slate-900 underline-offset-4 hover:underline",
                ai: "bg-gradient-to-r from-indigo-500 to-purple-600 text-white hover:from-indigo-600 hover:to-purple-700 border-0 shadow-sm",
            };
            const sizes = { default: "h-10 px-4 py-2", sm: "h-9 rounded-md px-3", lg: "h-11 rounded-md px-8", icon: "h-10 w-10" };
            return <button ref={ref} className={cn("inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 disabled:pointer-events-none disabled:opacity-50", variants[variant], sizes[size], className)} {...props} />;
        });

        const Input = React.forwardRef(({ className, ...props }, ref) => (
            <input className={cn("flex h-10 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-white placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 disabled:cursor-not-allowed disabled:opacity-50", className)} ref={ref} {...props} />
        ));

        const Card = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("rounded-xl border border-slate-200 bg-white text-slate-950 shadow-sm", className)} {...props} />
        ));
        const CardHeader = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
        ));
        const CardTitle = React.forwardRef(({ className, ...props }, ref) => (
            <h3 ref={ref} className={cn("text-2xl font-semibold leading-none tracking-tight", className)} {...props} />
        ));
        const CardContent = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
        ));

        const Badge = ({ className, variant = "default", ...props }) => {
            const variants = { default: "bg-slate-900 text-slate-50", secondary: "bg-slate-100 text-slate-900", destructive: "bg-red-500 text-slate-50", outline: "text-slate-950" };
            return <div className={cn("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-slate-950", variants[variant], className)} {...props} />;
        };

        const Progress = React.forwardRef(({ className, value, ...props }, ref) => (
            <div ref={ref} className={cn("relative h-4 w-full overflow-hidden rounded-full bg-slate-100", className)} {...props}>
                <div className="h-full w-full flex-1 bg-slate-900 transition-all" style={{ transform: `translateX(-${100 - (value || 0)}%)` }} />
            </div>
        ));

        const Label = React.forwardRef(({ className, ...props }, ref) => (
            <label ref={ref} className={cn("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70", className)} {...props} />
        ));

        const Select = ({ value, onValueChange, children, className }) => (
            <div className="relative">
                <select value={value} onChange={(e) => onValueChange(e.target.value)} className={cn("flex h-10 w-full items-center justify-between rounded-md border border-slate-200 bg-white px-3 py-2 text-sm placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-950 appearance-none", className)}>
                   {children}
                </select>
                <ChevronDown className="absolute right-3 top-3 h-4 w-4 opacity-50 pointer-events-none" />
            </div>
        );
        const SelectItem = ({ value, children }) => <option value={value}>{children}</option>;

        const Dialog = ({ open, onOpenChange, children }) => {
            if (!open) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 animate-in fade-in-0">
                    <div className="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative animate-in zoom-in-95 duration-200 max-h-[90vh] overflow-y-auto">
                        <button onClick={() => onOpenChange(false)} className="absolute right-4 top-4 rounded-sm opacity-70 hover:opacity-100"><X className="h-4 w-4" /></button>
                        {children}
                    </div>
                </div>
            );
        };

        function SettingsDialog({ isOpen, onOpenChange, apiKey, setApiKey }) {
            const [localKey, setLocalKey] = useState(apiKey);
            const handleSave = () => { setApiKey(localKey); onOpenChange(false); toast.success("API Key berhasil disimpan!"); };
            return (
                <Dialog open={isOpen} onOpenChange={onOpenChange}>
                    <div className="space-y-4">
                        <h2 className="text-lg font-semibold">Pengaturan API Key</h2>
                        <div className="space-y-2">
                            <Label>Gemini API Key</Label>
                            <Input value={localKey} onChange={(e) => setLocalKey(e.target.value)} placeholder="Masukkan Key Anda..." type="password" />
                            <p className="text-xs text-slate-500">Key disimpan di browser Anda (LocalStorage).</p>
                        </div>
                        <Button onClick={handleSave} className="w-full">Simpan</Button>
                    </div>
                </Dialog>
            );
        }

        // --- COMPONENTS ---

        // UPDATED: Split Bill AI with Sona Loading Icon
        function SplitBill({ apiKey, onOpenSettings, onAddTransaction, history, onSaveHistory }) {
            const [view, setView] = useState('calculator'); // 'calculator' | 'history'
            const [step, setStep] = useState(1); // 1: Upload, 2: Assign, 3: Result
            const [isScanning, setIsScanning] = useState(false);
            const [billItems, setBillItems] = useState([]); // {id, name, price, assignedTo: []}
            const [people, setPeople] = useState([{id: 1, name: 'Saya'}]);
            const [taxService, setTaxService] = useState(0);
            const [newPersonName, setNewPersonName] = useState("");
            
            // History State
            const [selectedHistory, setSelectedHistory] = useState(null);
            const receiptRef = useRef(null);

            // Step 1: Scan Receipt
            const handleScan = async (e) => {
                if (!apiKey) { toast.error("Perlu API Key"); onOpenSettings(); return; }
                const file = e.target.files?.[0]; if (!file) return;
                
                setIsScanning(true);
                try {
                    const model = getGeminiModel(apiKey);
                    const img = await fileToGenerativePart(file);
                    const prompt = `Analisis struk ini. Ekstrak daftar item dan harganya. Abaikan subtotal/total/pajak di list item. 
                    Kembalikan JSON array murni: [{ "name": "Nama Item", "price": 12000 }].`;
                    
                    const result = await model.generateContent([prompt, img]);
                    const text = result.response.text().replace(/```json|```/g, "").trim();
                    const data = JSON.parse(text);
                    
                    setBillItems(data.map((item, idx) => ({ ...item, id: idx, assignedTo: [] })));
                    setStep(2);
                    toast.success("Struk berhasil dibaca!");
                } catch (error) {
                    console.error(error);
                    toast.error("Gagal membaca struk. Coba foto yang lebih jelas.");
                } finally {
                    setIsScanning(false);
                    e.target.value = null;
                }
            };

            // Step 2: Helpers
            const addPerson = () => {
                if(!newPersonName) return;
                setPeople([...people, {id: Date.now(), name: newPersonName}]);
                setNewPersonName("");
            };

            const toggleAssignment = (itemId, personId) => {
                setBillItems(items => items.map(item => {
                    if (item.id !== itemId) return item;
                    const assigned = item.assignedTo.includes(personId)
                        ? item.assignedTo.filter(id => id !== personId)
                        : [...item.assignedTo, personId];
                    return { ...item, assignedTo: assigned };
                }));
            };

            const calculateResult = () => {
                const result = {};
                people.forEach(p => result[p.id] = { name: p.name, total: 0, items: [] });

                let subtotalAssigned = 0;

                billItems.forEach(item => {
                    if (item.assignedTo.length > 0) {
                        const splitPrice = item.price / item.assignedTo.length;
                        item.assignedTo.forEach(pid => {
                            if(result[pid]) {
                                result[pid].total += splitPrice;
                                result[pid].items.push({ ...item, share: splitPrice });
                            }
                        });
                        subtotalAssigned += item.price;
                    }
                });

                // Add tax/service proportionally
                const totalBill = billItems.reduce((sum, i) => sum + i.price, 0);
                const extraCharges = taxService; 
                
                Object.values(result).forEach(p => {
                    if (subtotalAssigned > 0) {
                        const share = p.total / subtotalAssigned;
                        p.total += extraCharges * share;
                    }
                });

                return Object.values(result);
            };

            const handleFinishSplit = () => {
                const results = calculateResult();
                const myShare = results.find(p => p.name === 'Saya')?.total || 0;
                
                // Add to Transactions
                if (myShare > 0) {
                    onAddTransaction({
                        type: 'expense',
                        amount: myShare,
                        category: 'Makanan', // Default category
                        description: `Split Bill (${new Date().toLocaleDateString('id-ID')})`,
                        date: new Date().toISOString().split('T')[0],
                        walletId: 'w1' // Default wallet, ideally selectable
                    });
                }

                // Add to History
                const historyItem = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    totalBill: billItems.reduce((sum, i) => sum + i.price, 0) + taxService,
                    results: results
                };
                onSaveHistory(historyItem);

                toast.success("Tersimpan! Bagian Anda masuk ke pengeluaran.");
                setStep(1);
                setBillItems([]);
                setPeople([{id: 1, name: 'Saya'}]);
                setTaxService(0);
            };

            const downloadReceipt = async () => {
                if (receiptRef.current) {
                    const canvas = await html2canvas(receiptRef.current);
                    const image = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `Sona-SplitBill-${Date.now()}.png`;
                    link.click();
                    toast.success("Gambar berhasil disimpan!");
                }
            };

            const totalBill = billItems.reduce((sum, i) => sum + i.price, 0);

            // RENDER LOGIC
            if (view === 'history') {
                return (
                    <div className="space-y-6">
                        <div className="flex items-center gap-2">
                            <Button variant="ghost" size="icon" onClick={() => { setView('calculator'); setSelectedHistory(null); }}><ChevronLeft/></Button>
                            <h2 className="text-2xl font-bold">Riwayat Split Bill</h2>
                        </div>

                        {selectedHistory ? (
                            <div className="space-y-4 animate-in fade-in">
                                <div ref={receiptRef} className="bg-white p-6 rounded-xl shadow-lg border border-slate-200 max-w-sm mx-auto">
                                    <div className="text-center mb-6 border-b pb-4 border-dashed">
                                        <h3 className="font-bold text-xl text-slate-800">Sona Split Bill</h3>
                                        <p className="text-sm text-slate-500">{new Date(selectedHistory.date).toLocaleString('id-ID')}</p>
                                    </div>
                                    <div className="space-y-4">
                                        {selectedHistory.results.map((res, idx) => (
                                            <div key={idx} className="flex justify-between items-center text-sm">
                                                <span className="font-medium">{res.name}</span>
                                                <span className="font-bold">{formatIDR(res.total)}</span>
                                            </div>
                                        ))}
                                        <div className="pt-4 border-t border-dashed flex justify-between items-center text-base font-bold">
                                            <span>Total</span>
                                            <span>{formatIDR(selectedHistory.totalBill)}</span>
                                        </div>
                                    </div>
                                    <div className="mt-8 text-center text-xs text-slate-400">
                                        Dibuat dengan Sona Finance
                                    </div>
                                </div>
                                <Button className="w-full" onClick={downloadReceipt}><ImageIcon className="mr-2 h-4 w-4"/> Simpan Gambar</Button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {history.length > 0 ? history.map(item => (
                                    <Card key={item.id} className="cursor-pointer hover:bg-slate-50" onClick={() => setSelectedHistory(item)}>
                                        <CardContent className="p-4 flex justify-between items-center">
                                            <div>
                                                <p className="font-medium">Split Bill</p>
                                                <p className="text-xs text-slate-500">{new Date(item.date).toLocaleDateString('id-ID')}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-bold text-blue-600">{formatIDR(item.totalBill)}</p>
                                                <p className="text-xs text-slate-500">{item.results.length} Orang</p>
                                            </div>
                                        </CardContent>
                                    </Card>
                                )) : <div className="text-center py-10 text-slate-500">Belum ada riwayat</div>}
                            </div>
                        )}
                    </div>
                );
            }

            // MAIN SPLIT BILL VIEW
            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold truncate">AI Split Bill</h2>
                            <p className="text-slate-500">Bagi tagihan otomatis</p>
                        </div>
                        <Button variant="outline" size="sm" onClick={() => setView('history')}><History className="mr-2 h-4 w-4"/> Riwayat</Button>
                    </div>

                    {step === 1 && (
                        <Card className="border-dashed border-2 bg-slate-50">
                            <CardContent className="p-8 flex flex-col items-center text-center space-y-4">
                                <div className="bg-white p-4 rounded-full shadow-sm">
                                    {isScanning ? <img src="Sona.png" className="h-8 w-8 animate-spin" alt="Loading"/> : <Camera className="h-8 w-8 text-purple-600"/>}
                                </div>
                                <div>
                                    <h3 className="font-semibold text-lg">Upload Foto Struk</h3>
                                    <p className="text-sm text-slate-500">AI akan membaca item dan harga untuk Anda</p>
                                </div>
                                <div className="relative w-full max-w-xs">
                                    <input type="file" accept="image/*" onChange={handleScan} disabled={isScanning} className="absolute inset-0 opacity-0 cursor-pointer z-10" />
                                    <Button disabled={isScanning} className="w-full bg-purple-600 hover:bg-purple-700 text-white">
                                        {isScanning ? "Menganalisis..." : "Pilih Foto"}
                                    </Button>
                                </div>
                                {!apiKey && <p className="text-xs text-red-500 font-medium bg-red-50 px-2 py-1 rounded">*Perlu API Key di Pengaturan</p>}
                            </CardContent>
                        </Card>
                    )}

                    {step === 2 && (
                        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
                            {/* People Management */}
                            <Card>
                                <CardHeader><CardTitle className="text-base">1. Siapa saja yang patungan?</CardTitle></CardHeader>
                                <CardContent>
                                    <div className="flex flex-wrap gap-2 mb-4">
                                        {people.map(p => (
                                            <Badge key={p.id} variant="secondary" className="px-3 py-1 text-sm flex gap-2">
                                                {p.name} {p.id !== 1 && <button onClick={() => setPeople(people.filter(x => x.id !== p.id))} className="text-slate-400 hover:text-red-500"><X size={12}/></button>}
                                            </Badge>
                                        ))}
                                    </div>
                                    <div className="flex gap-2">
                                        <Input value={newPersonName} onChange={e => setNewPersonName(e.target.value)} placeholder="Nama Teman" className="h-9" onKeyDown={e => e.key === 'Enter' && addPerson()} />
                                        <Button size="sm" onClick={addPerson}><UserPlus size={16}/></Button>
                                    </div>
                                </CardContent>
                            </Card>

                            {/* Item Assignment */}
                            <Card>
                                <CardHeader className="flex flex-row justify-between items-center">
                                    <CardTitle className="text-base">2. Siapa pesan apa?</CardTitle>
                                    <span className="text-sm font-bold text-slate-600">Total: {formatIDR(totalBill)}</span>
                                </CardHeader>
                                <CardContent className="space-y-4">
                                    {billItems.map(item => (
                                        <div key={item.id} className="p-3 border rounded-lg bg-white">
                                            <div className="flex justify-between mb-2">
                                                <span className="font-medium text-sm">{item.name}</span>
                                                <span className="font-bold text-sm">{formatIDR(item.price)}</span>
                                            </div>
                                            <div className="flex flex-wrap gap-1">
                                                {people.map(p => {
                                                    const isAssigned = item.assignedTo.includes(p.id);
                                                    return (
                                                        <button 
                                                            key={p.id}
                                                            onClick={() => toggleAssignment(item.id, p.id)}
                                                            className={cn(
                                                                "text-xs px-2 py-1 rounded-full border transition-all",
                                                                isAssigned ? "bg-blue-100 border-blue-200 text-blue-700 font-medium" : "bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100"
                                                            )}
                                                        >
                                                            {p.name} {isAssigned && "✓"}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                    
                                    <div className="pt-4 border-t">
                                        <Label>Biaya Tambahan (Pajak/Layanan)</Label>
                                        <Input 
                                            type="number" 
                                            value={taxService} 
                                            onChange={e => setTaxService(parseFloat(e.target.value) || 0)} 
                                            placeholder="0"
                                            className="mt-1"
                                        />
                                        <p className="text-xs text-slate-400 mt-1">Akan dibagi proporsional</p>
                                    </div>
                                </CardContent>
                            </Card>

                            <div className="flex gap-2">
                                <Button variant="outline" className="flex-1" onClick={() => setStep(1)}>Ulang</Button>
                                <Button className="flex-1 bg-green-600 hover:bg-green-700" onClick={() => setStep(3)}>Hitung</Button>
                            </div>
                        </div>
                    )}

                    {step === 3 && (
                        <div className="space-y-4 animate-in zoom-in-95">
                            <Card className="bg-gradient-to-br from-slate-900 to-slate-800 text-white border-0">
                                <CardHeader><CardTitle className="text-center">Hasil Pembagian</CardTitle></CardHeader>
                                <CardContent className="space-y-4">
                                    {calculateResult().map((res, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-3 bg-white/10 rounded-lg">
                                            <div>
                                                <div className="font-bold text-lg">{res.name}</div>
                                                <div className="text-xs text-slate-300">{res.items.length} item</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-xl font-bold text-green-400">{formatIDR(res.total)}</div>
                                            </div>
                                        </div>
                                    ))}
                                </CardContent>
                            </Card>
                            
                            <Button className="w-full bg-blue-600 hover:bg-blue-700" onClick={handleFinishSplit}>
                                <Check className="mr-2 h-4 w-4"/> Submit & Simpan ke Riwayat
                            </Button>
                            <Button variant="ghost" className="w-full" onClick={() => setStep(2)}>Edit Kembali</Button>
                        </div>
                    )}
                </div>
            );
        }

        function MonthlyInsight({ transactions, isPrivacyMode }) {
            const availableMonths = useMemo(() => {
                const months = new Set(transactions.map(t => t.date.substring(0, 7)));
                return Array.from(months).sort().reverse();
            }, [transactions]);

            const [selectedMonth, setSelectedMonth] = useState(availableMonths[0] || new Date().toISOString().substring(0, 7));

            const monthlyData = useMemo(() => transactions.filter(t => t.date.startsWith(selectedMonth)), [transactions, selectedMonth]);
            
            const income = monthlyData.filter(t => t.type === "income").reduce((sum, t) => sum + t.amount, 0);
            const expense = monthlyData.filter(t => t.type === "expense").reduce((sum, t) => sum + t.amount, 0);
            
            const categoryData = useMemo(() => {
                const stats = monthlyData.filter(t => t.type === "expense").reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount; 
                    return acc;
                }, {});
                
                return Object.entries(stats)
                    .map(([name, value]) => ({ 
                        name, 
                        value, 
                        percent: expense > 0 ? (value / expense) * 100 : 0 
                    }))
                    .sort((a, b) => b.value - a.value);
            }, [monthlyData, expense]);

            const COLORS = ["#0088FE", "#00C49F", "#FFBB28", "#FF8042", "#8884d8", "#82ca9d", "#ffc658", "#ff7c7c"];

            if (availableMonths.length === 0) return <div className="text-center py-10 text-slate-500">Belum ada data transaksi.</div>;

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold truncate">Insight Bulanan</h2>
                        <Select value={selectedMonth} onValueChange={setSelectedMonth} className="w-32">
                            {availableMonths.map(m => <SelectItem key={m} value={m}>{m}</SelectItem>)}
                        </Select>
                    </div>
                    
                    {/* Summary Cards */}
                    <div className="grid gap-4 md:grid-cols-3">
                        <Card className="bg-green-50 border-green-100"><CardContent className="p-4"><div className="text-sm font-medium text-green-700">Pemasukan</div><div className="text-2xl font-bold text-green-700 truncate">{displayMoney(income, isPrivacyMode)}</div></CardContent></Card>
                        <Card className="bg-red-50 border-red-100"><CardContent className="p-4"><div className="text-sm font-medium text-red-700">Pengeluaran</div><div className="text-2xl font-bold text-red-700 truncate">{displayMoney(expense, isPrivacyMode)}</div></CardContent></Card>
                        <Card className="bg-blue-50 border-blue-100"><CardContent className="p-4"><div className="text-sm font-medium text-blue-700">Sisa</div><div className="text-2xl font-bold text-blue-700 truncate">{displayMoney(income - expense, isPrivacyMode)}</div></CardContent></Card>
                    </div>

                    {/* Breakdown Kategori (UPDATED) */}
                    <div className="grid gap-6 md:grid-cols-2">
                        {/* Chart */}
                        <Card>
                            <CardHeader><CardTitle>Distribusi Pengeluaran</CardTitle></CardHeader>
                            <CardContent>
                                <div className="h-[300px]">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie 
                                                data={categoryData} 
                                                cx="50%" 
                                                cy="50%" 
                                                innerRadius={60}
                                                outerRadius={80} 
                                                paddingAngle={5}
                                                fill="#8884d8" 
                                                dataKey="value" 
                                                label={({percent}) => `${(percent * 100).toFixed(0)}%`}
                                            >
                                                {categoryData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                            </Pie>
                                            <RechartsTooltip formatter={(val) => displayMoney(val, isPrivacyMode)} />
                                            <Legend />
                                        </PieChart>
                                    </ResponsiveContainer>
                                </div>
                            </CardContent>
                        </Card>

                        {/* List Persentase (NEW) */}
                        <Card>
                            <CardHeader><CardTitle>Rincian Kategori</CardTitle></CardHeader>
                            <CardContent>
                                <div className="space-y-5">
                                    {categoryData.length > 0 ? categoryData.map((cat, index) => (
                                        <div key={cat.name} className="space-y-2">
                                            <div className="flex justify-between text-sm">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-3 h-3 rounded-full" style={{ backgroundColor: COLORS[index % COLORS.length] }}></div>
                                                    <span className="font-medium">{cat.name}</span>
                                                </div>
                                                <div className="text-right">
                                                    <span className="font-bold block">{cat.percent.toFixed(1)}%</span>
                                                    <span className="text-xs text-slate-500">{displayMoney(cat.value, isPrivacyMode)}</span>
                                                </div>
                                            </div>
                                            <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                                <div className="h-full rounded-full transition-all" style={{ width: `${cat.percent}%`, backgroundColor: COLORS[index % COLORS.length] }}></div>
                                            </div>
                                        </div>
                                    )) : (
                                        <div className="text-center text-slate-500 py-4">Belum ada pengeluaran</div>
                                    )}
                                </div>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            );
        }

        // Updated AI Advisor with Sona Loading Icon
        function AIAdvisor({ transactions, budgets, goals, apiKey, onOpenSettings }) {
            const [advice, setAdvice] = useState("");
            const [isLoading, setIsLoading] = useState(false);

            const generateAdvice = async () => {
                if (!apiKey) { toast.error("API Key belum diatur."); onOpenSettings(); return; }
                setIsLoading(true);
                try {
                    const model = getGeminiModel(apiKey);
                    const prompt = `Analisis keuangan singkat dalam bahasa Indonesia. Total masuk: ${transactions.filter(t=>t.type=='income').reduce((s,t)=>s+t.amount,0)}, Keluar: ${transactions.filter(t=>t.type=='expense').reduce((s,t)=>s+t.amount,0)}. Beri 3 saran praktis.`;
                    const result = await model.generateContent(prompt);
                    setAdvice(result.response.text());
                } catch (error) { console.error(error); toast.error("Gagal memuat saran AI."); } 
                finally { setIsLoading(false); }
            };
            const md = window.markdownit();

            return (
                <div className="space-y-6">
                    <div className="flex flex-col md:flex-row justify-between gap-4">
                        <div><h2 className="text-2xl font-bold flex items-center gap-2"><Sparkles className="text-purple-600"/> AI Advisor</h2><p className="text-slate-500">Analisis cerdas keuangan Anda</p></div>
                        <Button onClick={generateAdvice} disabled={isLoading} variant="ai">{isLoading ? <img src="Sona.png" className="h-4 w-4 animate-spin mr-2" alt="Loading"/> : <Bot className="mr-2"/>} {advice ? "Analisis Ulang" : "Analisis Sekarang"}</Button>
                    </div>
                    {!apiKey && <div className="bg-yellow-50 text-yellow-800 p-4 rounded-lg text-sm mb-4">⚠️ API Key belum diatur. <button onClick={onOpenSettings} className="underline font-bold">Atur di sini</button></div>}
                    <Card className="min-h-[200px] border-purple-100 shadow-sm">
                        <CardContent className="p-6">
                            {isLoading ? <div className="flex flex-col items-center justify-center h-40 text-slate-400"><img src="Sona.png" className="h-8 w-8 animate-spin mb-2" alt="Loading"/>Menganalisis...</div> : 
                             advice ? <div className="prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: md.render(advice) }}/> : 
                             <div className="text-center text-slate-400 py-10"><Lightbulb className="h-10 w-10 mx-auto mb-2 opacity-50"/>Klik tombol untuk analisis AI</div>}
                        </CardContent>
                    </Card>
                </div>
            );
        }

        // --- DASHBOARD ---
        function Dashboard({ transactions, budgets, goals, isPrivacy, onNavigate }) {
            const income = transactions.filter(t => t.type === "income").reduce((s, t) => s + t.amount, 0);
            const expense = transactions.filter(t => t.type === "expense").reduce((s, t) => s + t.amount, 0);
            
            // Calculate Monthly Cash Flow
            const cashFlowData = useMemo(() => {
                const months = {};
                for(let i=5; i>=0; i--) {
                    const d = new Date(); d.setMonth(d.getMonth() - i);
                    const key = d.toISOString().slice(0, 7); 
                    months[key] = { name: d.toLocaleString('id-ID', {month:'short'}), income: 0, expense: 0, net: 0 };
                }
                transactions.forEach(t => {
                    const key = t.date.slice(0, 7);
                    if(months[key]) {
                        if(t.type === 'income') months[key].income += t.amount;
                        else months[key].expense += t.amount;
                    }
                });
                return Object.values(months).map(m => ({ ...m, net: m.income - m.expense }));
            }, [transactions]);

            const recentTransactions = useMemo(() => [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5), [transactions]);

            return (
                <div className="space-y-6">
                    <div><h2 className="text-2xl font-bold truncate">Ringkasan</h2><p className="text-slate-500">Overview keuangan</p></div>
                    
                    {/* Summary Cards */}
                    <div className="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
                        <Card className="bg-blue-600 text-white border-0 shadow-lg">
                            <CardHeader className="pb-2"><CardTitle className="text-sm font-medium opacity-90 truncate">Saldo</CardTitle></CardHeader>
                            <CardContent><div className="text-2xl font-bold truncate">{displayMoney(income - expense, isPrivacy)}</div></CardContent>
                        </Card>
                        <Card className="bg-green-600 text-white border-0 shadow-lg">
                            <CardHeader className="pb-2"><CardTitle className="text-sm font-medium opacity-90 truncate">Pemasukan</CardTitle></CardHeader>
                            <CardContent><div className="text-2xl font-bold truncate">{displayMoney(income, isPrivacy)}</div></CardContent>
                        </Card>
                        <Card className="bg-red-600 text-white border-0 shadow-lg">
                            <CardHeader className="pb-2"><CardTitle className="text-sm font-medium opacity-90 truncate">Pengeluaran</CardTitle></CardHeader>
                            <CardContent><div className="text-2xl font-bold truncate">{displayMoney(expense, isPrivacy)}</div></CardContent>
                        </Card>
                        <Card className="bg-purple-600 text-white border-0 shadow-lg">
                            <CardHeader className="pb-2"><CardTitle className="text-sm font-medium opacity-90 truncate">Target</CardTitle></CardHeader>
                            <CardContent><div className="text-2xl font-bold truncate">{goals.length} Aktif</div></CardContent>
                        </Card>
                    </div>

                    <div className="grid gap-6 md:grid-cols-2">
                        {/* Cash Flow Chart */}
                        <Card>
                            <CardHeader><CardTitle>Arus Kas Bulanan (Net)</CardTitle></CardHeader>
                            <CardContent>
                                <div className="h-[250px]">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={cashFlowData}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="name" axisLine={false} tickLine={false} />
                                            <YAxis hide />
                                            <RechartsTooltip cursor={{fill: 'transparent'}} formatter={(val) => displayMoney(val, isPrivacy)} contentStyle={{borderRadius: '8px'}} />
                                            <ReferenceLine y={0} stroke="#000" />
                                            <Bar dataKey="net" name="Net Cash Flow" radius={[4, 4, 0, 0]}>
                                                {cashFlowData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.net >= 0 ? '#22c55e' : '#ef4444'} />)}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </CardContent>
                        </Card>

                        {/* Recent Transactions */}
                        <Card>
                            <CardHeader className="flex flex-row items-center justify-between">
                                <CardTitle>Riwayat Transaksi</CardTitle>
                                <Button variant="ghost" size="sm" onClick={() => onNavigate('transactions')} className="text-xs">Lihat Semua <ArrowRight className="ml-1 h-3 w-3" /></Button>
                            </CardHeader>
                            <CardContent>
                                <div className="space-y-4">
                                    {recentTransactions.length > 0 ? (
                                        recentTransactions.map((t) => (
                                            <div key={t.id} className="flex items-center justify-between">
                                                <div className="flex items-center gap-3 min-w-0">
                                                    <div className={cn("p-2 rounded-full shrink-0", t.type === 'income' ? "bg-green-100 text-green-600" : "bg-red-100 text-red-600")}>
                                                        {t.type === 'income' ? <ArrowDownCircle size={16} /> : <ArrowUpCircle size={16} />}
                                                    </div>
                                                    <div className="min-w-0">
                                                        <p className="font-medium text-sm truncate">{t.description}</p>
                                                        <p className="text-xs text-slate-500 truncate">{t.category} • {new Date(t.date).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'})}</p>
                                                    </div>
                                                </div>
                                                <span className={cn("font-semibold text-sm whitespace-nowrap", t.type === 'income' ? "text-green-600" : "text-red-600")}>
                                                    {t.type === 'income' ? '+' : '-'}{displayMoney(t.amount, isPrivacy)}
                                                </span>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="text-center text-slate-400 py-8 text-sm">Belum ada transaksi</div>
                                    )}
                                </div>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            );
        }

        // Updated ReceiptScanner with Sona Loading Icon
        function ReceiptScanner({ onScan, apiKey, onSettings }) {
            const [loading, setLoading] = useState(false);
            const handleFile = async (e) => {
                if(!apiKey) { toast.error("Perlu API Key"); onSettings(); return; }
                const file = e.target.files?.[0]; if(!file) return;
                setLoading(true);
                try {
                    const model = getGeminiModel(apiKey);
                    const img = await fileToGenerativePart(file);
                    const res = await model.generateContent(["Extract JSON: {amount:number, description:string, category:string, date:YYYY-MM-DD}", img]);
                    const data = JSON.parse(res.response.text().replace(/```json|```/g, ""));
                    onScan(data.amount, data.description, data.category, data.date);
                } catch(e) { console.error(e); toast.error("Gagal scan struk"); }
                finally { setLoading(false); e.target.value = null; }
            };
            return (
                <Card className="border-dashed border-2 bg-slate-50 mb-6">
                    <CardContent className="p-6 flex flex-col items-center text-center">
                        <div className="bg-white p-3 rounded-full mb-3 shadow-sm relative">
                            {loading ? <img src="Sona.png" className="h-6 w-6 animate-spin" alt="Loading"/> : <Camera className="h-6 w-6 text-purple-600"/>}
                        </div>
                        <h3 className="font-semibold text-sm">AI Scan Struk</h3>
                        <p className="text-xs text-slate-500 mb-3">Upload foto struk belanja</p>
                        <div className="relative">
                            <input type="file" accept="image/*" onChange={handleFile} disabled={loading} className="absolute inset-0 opacity-0 cursor-pointer"/>
                            <Button disabled={loading} size="sm" className="w-full">Pilih Foto</Button>
                        </div>
                    </CardContent>
                </Card>
            );
        }

        // Updated Transactions with Sona Loading Icon
        function Transactions({ transactions, wallets, onAdd, onDelete, categories, apiKey, onSettings, isPrivacy }) {
            const [isOpen, setOpen] = useState(false);
            const [form, setForm] = useState({ type: 'expense', amount: '', category: categories[0], description: '', date: new Date().toISOString().split('T')[0], walletId: wallets[0]?.id });
            const [smartInput, setSmartInput] = useState("");
            const [smartLoading, setSmartLoading] = useState(false);

            const handleSmart = async () => {
                if(!apiKey) { toast.error("Perlu API Key"); onSettings(); return; }
                if(!smartInput) return;
                setSmartLoading(true);
                try {
                    const model = getGeminiModel(apiKey);
                    const res = await model.generateContent(`Parse transaction JSON {amount:number, category:string (from [${categories}]), description:string} from: "${smartInput}"`);
                    const data = JSON.parse(res.response.text().replace(/```json|```/g, ""));
                    setForm(prev => ({ ...prev, ...data }));
                    toast.success("Terisi otomatis!"); setSmartInput("");
                } catch(e) { toast.error("Gagal memproses"); } finally { setSmartLoading(false); }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({ ...form, amount: parseFloat(form.amount) });
                setOpen(false); setForm({ ...form, amount: '', description: '' });
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold truncate">Transaksi</h2>
                        <Button onClick={() => setOpen(true)} size="sm"><Plus className="h-4 w-4 mr-2"/>Tambah</Button>
                    </div>
                    
                    <ReceiptScanner onScan={(a,d,c,dt) => { setForm(f=>({...f, amount:a, description:d, category:c, date:dt})); setOpen(true); }} apiKey={apiKey} onSettings={onSettings} />

                    <div className="space-y-3">
                        {transactions.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => (
                            <Card key={t.id} className="hover:shadow-md transition-shadow">
                                <CardContent className="p-4 flex items-center justify-between gap-3">
                                    <div className="flex items-center gap-3 min-w-0 flex-1">
                                        <div className={cn("p-2 rounded-lg shrink-0", t.type==='income'?"bg-green-100 text-green-600":"bg-red-100 text-red-600")}>
                                            {t.type==='income'?<ArrowDownCircle size={20}/>:<ArrowUpCircle size={20}/>}
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            <div className="font-semibold truncate text-sm sm:text-base">{t.description}</div>
                                            <div className="text-xs text-slate-500 truncate">{t.category} • {t.date}</div>
                                        </div>
                                    </div>
                                    <div className="text-right shrink-0">
                                        <div className={cn("font-bold text-sm sm:text-base whitespace-nowrap", t.type==='income'?"text-green-600":"text-red-600")}>
                                            {t.type==='income'?'+':'-'}{displayMoney(t.amount, isPrivacy)}
                                        </div>
                                        <button onClick={()=>onDelete(t.id)} className="text-xs text-red-400 mt-1 hover:underline">Hapus</button>
                                    </div>
                                </CardContent>
                            </Card>
                        ))}
                    </div>

                    <Dialog open={isOpen} onOpenChange={setOpen}>
                        <div className="space-y-4">
                            <h2 className="font-bold text-lg">Transaksi Baru</h2>
                            <div className="bg-purple-50 p-3 rounded-lg border border-purple-100">
                                <Label className="text-purple-700 text-xs flex gap-1 mb-2"><Sparkles size={12}/> AI Smart Input</Label>
                                <div className="flex gap-2">
                                    <Input value={smartInput} onChange={e=>setSmartInput(e.target.value)} placeholder="Contoh: Beli bakso 15rb" className="h-8 text-sm flex-1 w-auto min-w-0"/>
                                    <Button size="sm" onClick={handleSmart} disabled={smartLoading} className="h-8 px-2 bg-purple-600">{smartLoading?<img src="Sona.png" className="h-4 w-4 animate-spin" alt="Loading"/>:<Sparkles size={14}/>}</Button>
                                </div>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-3">
                                <div className="flex gap-2">
                                    <Button type="button" onClick={()=>setForm({...form, type:'expense'})} variant={form.type==='expense'?'default':'outline'} className={cn("flex-1", form.type==='expense'&&"bg-red-600")}>Pengeluaran</Button>
                                    <Button type="button" onClick={()=>setForm({...form, type:'income'})} variant={form.type==='income'?'default':'outline'} className={cn("flex-1", form.type==='income'&&"bg-green-600")}>Pemasukan</Button>
                                </div>
                                <div className="space-y-1"><Label>Dompet</Label><Select value={form.walletId} onValueChange={v=>setForm({...form, walletId:v})}>{wallets.map(w=><SelectItem key={w.id} value={w.id}>{w.name}</SelectItem>)}</Select></div>
                                <div className="space-y-1"><Label>Jumlah</Label><Input type="number" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} required/></div>
                                <div className="space-y-1"><Label>Kategori</Label><Select value={form.category} onValueChange={v=>setForm({...form, category:v})}>{categories.map(c=><SelectItem key={c} value={c}>{c}</SelectItem>)}</Select></div>
                                <div className="space-y-1"><Label>Ket.</Label><Input value={form.description} onChange={e=>setForm({...form, description:e.target.value})} required/></div>
                                <div className="space-y-1"><Label>Tgl</Label><Input type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} required/></div>
                                <Button type="submit" className="w-full">Simpan</Button>
                            </form>
                        </div>
                    </Dialog>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [tab, setTab] = useState("dashboard");
            const [mobileMenu, setMobileMenu] = useState(false);
            const [settingsOpen, setSettingsOpen] = useState(false);
            
            // --- PRIVACY STATE (New) ---
            const [isPrivacy, setPrivacy] = useState(false);
            
            // Data State
            const [wallets, setWallets] = useState(() => JSON.parse(localStorage.getItem("sona-wallets") || '[{"id":"w1","name":"Tunai","balance":0,"color":"bg-blue-500","icon":"cash"}]'));
            const [trx, setTrx] = useState(() => JSON.parse(localStorage.getItem("sona-trx") || '[]'));
            const [budgets, setBudgets] = useState(() => JSON.parse(localStorage.getItem("sona-budgets") || '[]'));
            const [goals, setGoals] = useState(() => JSON.parse(localStorage.getItem("sona-goals") || '[]'));
            const [splitHistory, setSplitHistory] = useState(() => JSON.parse(localStorage.getItem("sona-split-bills") || '[]'));
            const [apiKey, setApiKey] = useState(() => localStorage.getItem("sona_api_key") || "");

            // Persist
            useEffect(() => { localStorage.setItem("sona-wallets", JSON.stringify(wallets)); }, [wallets]);
            useEffect(() => { localStorage.setItem("sona-trx", JSON.stringify(trx)); }, [trx]);
            useEffect(() => { localStorage.setItem("sona-budgets", JSON.stringify(budgets)); }, [budgets]);
            useEffect(() => { localStorage.setItem("sona-goals", JSON.stringify(goals)); }, [goals]);
            useEffect(() => { localStorage.setItem("sona-split-bills", JSON.stringify(splitHistory)); }, [splitHistory]);
            useEffect(() => { localStorage.setItem("sona_api_key", apiKey); }, [apiKey]);

            // Handlers
            const addTrx = (t) => { const nt={...t, id: Date.now().toString()}; setTrx([...trx, nt]); if(t.type==='expense') setBudgets(bs=>bs.map(b=>b.category===t.category?{...b, spent:b.spent+t.amount}:b)); toast.success("Disimpan"); };
            const delTrx = (id) => { const t = trx.find(x=>x.id===id); if(t?.type==='expense') setBudgets(bs=>bs.map(b=>b.category===t.category?{...b, spent: Math.max(0, b.spent-t.amount)}:b)); setTrx(x=>x.filter(i=>i.id!==id)); toast.success("Dihapus"); };
            const addSplitHistory = (item) => setSplitHistory([item, ...splitHistory]);
            
            const exportData = () => {
                const blob = new Blob([JSON.stringify({wallets, trx, budgets, goals, splitHistory})], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `sona-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
            };
            const importData = (e) => {
                const file = e.target.files[0]; if(!file) return;
                const r = new FileReader(); r.onload = (ev) => {
                    try { const d = JSON.parse(ev.target.result); setWallets(d.wallets); setTrx(d.trx); setBudgets(d.budgets); setGoals(d.goals); if(d.splitHistory) setSplitHistory(d.splitHistory); toast.success("Data dipulihkan"); } catch(err){ toast.error("File rusak"); }
                }; r.readAsText(file);
            };

            const CATEGORIES = ["Makanan", "Transport", "Belanja", "Tagihan", "Hiburan", "Kesehatan", "Pendidikan", "Lainnya"];

            const renderContent = () => {
                switch(tab) {
                    case "dashboard": return <Dashboard transactions={trx} budgets={budgets} goals={goals} isPrivacy={isPrivacy} onNavigate={setTab} />;
                    case "transactions": return <Transactions transactions={trx} wallets={wallets} onAdd={addTrx} onDelete={delTrx} categories={CATEGORIES} apiKey={apiKey} onSettings={()=>setSettingsOpen(true)} isPrivacy={isPrivacy} />;
                    case "wallets": return (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Dompet</h2><Button size="sm" onClick={()=>{const n=prompt("Nama Dompet:"); if(n) setWallets([...wallets, {id:'w'+Date.now(), name:n, balance:0, color:'bg-blue-500'}])}}><Plus size={16}/></Button></div>
                            <div className="grid gap-3 md:grid-cols-2">{wallets.map(w => {
                                const bal = w.balance + trx.filter(t=>t.walletId===w.id && t.type==='income').reduce((s,t)=>s+t.amount,0) - trx.filter(t=>t.walletId===w.id && t.type==='expense').reduce((s,t)=>s+t.amount,0);
                                return <Card key={w.id} className={`${w.color} text-white`}><CardContent className="p-4"><div className="font-bold text-lg">{w.name}</div><div className="text-2xl font-bold mt-2 truncate">{displayMoney(bal, isPrivacy)}</div></CardContent></Card>
                            })}</div>
                        </div>
                    );
                    case "budgets": return (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Anggaran</h2><Button size="sm" onClick={()=>{const c=prompt("Kategori:"); const l=prompt("Batas:"); if(c&&l) setBudgets([...budgets, {id:'b'+Date.now(), category:c, limit:parseFloat(l), spent:0}])}}><Plus size={16}/></Button></div>
                            <div className="grid gap-3 md:grid-cols-2">{budgets.map(b => (
                                <Card key={b.id}><CardContent className="p-4 space-y-2"><div className="flex justify-between font-medium"><span>{b.category}</span><span>{displayMoney(b.spent, isPrivacy)} / {displayMoney(b.limit, isPrivacy)}</span></div><Progress value={(b.spent/b.limit)*100} className={b.spent>b.limit?"bg-red-100":"bg-slate-100"}/></CardContent></Card>
                            ))}</div>
                        </div>
                    );
                    case "goals": return (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Target</h2><Button size="sm" onClick={()=>{const n=prompt("Nama:"); const t=prompt("Target:"); if(n&&t) setGoals([...goals, {id:'g'+Date.now(), name:n, targetAmount:parseFloat(t), currentAmount:0}])}}><Plus size={16}/></Button></div>
                            <div className="grid gap-3 md:grid-cols-2">{goals.map(g => (
                                <Card key={g.id}><CardContent className="p-4 space-y-2">
                                    <div className="flex justify-between font-medium"><span>{g.name}</span><span>{displayMoney(g.currentAmount, isPrivacy)} / {displayMoney(g.targetAmount, isPrivacy)}</span></div>
                                    <Progress value={(g.currentAmount/g.targetAmount)*100}/>
                                    <Button size="sm" variant="outline" className="w-full mt-2" onClick={()=>{const a=prompt("Nabung berapa?"); if(a) setGoals(gs=>gs.map(x=>x.id===g.id?{...x, currentAmount:x.currentAmount+parseFloat(a)}:x))}}>+ Nabung</Button>
                                </CardContent></Card>
                            ))}</div>
                        </div>
                    );
                    // New Insight Tab
                    case "insight": return <MonthlyInsight transactions={trx} isPrivacyMode={isPrivacy} />;
                    case "ai-advisor": return <AIAdvisor transactions={trx} budgets={budgets} goals={goals} apiKey={apiKey} onOpenSettings={()=>setSettingsOpen(true)} />;
                    case "split-bill": return <SplitBill apiKey={apiKey} onOpenSettings={()=>setSettingsOpen(true)} onAddTransaction={addTrx} history={splitHistory} onSaveHistory={addSplitHistory} />;
                    default: return null;
                }
            };

            return (
                <div className="flex min-h-screen bg-slate-50">
                    <Toaster position="top-center" richColors />
                    <SettingsDialog isOpen={settingsOpen} onOpenChange={setSettingsOpen} apiKey={apiKey} setApiKey={setApiKey} />
                    
                    {/* Desktop Sidebar */}
                    <aside className="hidden lg:flex flex-col w-64 bg-white border-r fixed h-full">
                        <div className="p-6 border-b flex items-center gap-2">
                            <img src="Sona.png" onError={(e)=>e.target.style.display='none'} className="h-8 w-8 object-contain"/>
                            <h1 className="text-2xl font-bold text-blue-600">Sona</h1>
                        </div>
                        <nav className="p-4 space-y-1 flex-1">
                            {[
                                {id:'dashboard', l:'Beranda', i:LayoutDashboard},
                                {id:'transactions', l:'Transaksi', i:Receipt},
                                {id:'wallets', l:'Dompet', i:WalletIcon},
                                {id:'budgets', l:'Anggaran', i:PiggyBank},
                                {id:'goals', l:'Target', i:Target},
                                // Insight in sidebar
                                {id:'insight', l:'Insight', i:LineChart},
                                {id:'split-bill', l:'Split Bill', i:Users},
                                {id:'ai-advisor', l:'AI Advisor', i:Sparkles, c:'text-purple-600'}
                            ].map(x => (
                                <button key={x.id} onClick={()=>setTab(x.id)} className={cn("w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors", tab===x.id?"bg-slate-100 text-blue-600": "text-slate-600 hover:bg-slate-50", x.c)}>
                                    <x.i className="h-5 w-5"/> {x.l}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t space-y-2">
                            {/* Privacy Toggle Desktop */}
                            <div className="flex items-center justify-between px-2 text-sm text-slate-500">
                                <span>Privasi</span>
                                <button onClick={()=>setPrivacy(!isPrivacy)}>{isPrivacy?<EyeOff size={16}/>:<Eye size={16}/>}</button>
                            </div>
                            <Button variant="ghost" className="w-full justify-start text-xs" onClick={()=>setSettingsOpen(true)}><Settings className="mr-2 h-4 w-4"/> API Key</Button>
                            <Button variant="ghost" className="w-full justify-start text-xs" onClick={exportData}><Download className="mr-2 h-4 w-4"/> Backup</Button>
                            <label className="flex items-center w-full px-4 py-2 text-xs font-medium text-slate-600 cursor-pointer hover:bg-slate-100 rounded-md">
                                <Upload className="mr-2 h-4 w-4"/> Restore
                                <input type="file" className="hidden" onChange={importData} accept=".json"/>
                            </label>
                        </div>
                    </aside>

                    {/* Mobile Layout */}
                    <div className="flex-1 flex flex-col lg:pl-64 h-screen overflow-hidden">
                        <header className="lg:hidden bg-white border-b p-4 flex justify-between items-center sticky top-0 z-20">
                            <div className="flex items-center gap-2 font-bold text-xl text-blue-600">
                                <img src="Sona.png" onError={(e)=>e.target.style.display='none'} className="h-6 w-6 object-contain"/> Sona
                            </div>
                            <div className="flex gap-2">
                                {/* Privacy Toggle Mobile */}
                                <button onClick={()=>setPrivacy(!isPrivacy)} className="p-2 text-slate-600">{isPrivacy?<EyeOff size={20}/>:<Eye size={20}/>}</button>
                                <button onClick={()=>setMobileMenu(true)}><Menu/></button>
                            </div>
                        </header>

                        <main className="flex-1 overflow-auto p-4 pb-24">
                            {renderContent()}
                        </main>

                        {/* Mobile Bottom Nav */}
                        <nav className="lg:hidden bg-white border-t p-2 grid grid-cols-5 fixed bottom-0 w-full z-20">
                            {[
                                {id:'dashboard', l:'Home', i:LayoutDashboard},
                                {id:'transactions', l:'Trx', i:Receipt},
                                {id:'wallets', l:'Dompet', i:WalletIcon},
                                {id:'budgets', l:'Budget', i:PiggyBank},
                                {id:'goals', l:'Goal', i:Target},
                            ].map(x => (
                                <button key={x.id} onClick={()=>setTab(x.id)} className={cn("flex flex-col items-center p-2 rounded-lg text-[10px]", tab===x.id?"text-blue-600":"text-slate-400")}>
                                    <x.i className="h-5 w-5 mb-1"/> {x.l}
                                </button>
                            ))}
                        </nav>

                        {/* Mobile Hamburger Menu */}
                        {mobileMenu && (
                            <div className="fixed inset-0 bg-white z-50 p-6 flex flex-col animate-in slide-in-from-right overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold">Menu</h2>
                                    <button onClick={()=>setMobileMenu(false)}><X/></button>
                                </div>
                                <div className="space-y-2 flex-1">
                                    <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Utama</p>
                                    {[
                                        {id:'dashboard', l:'Beranda', i:LayoutDashboard},
                                        {id:'transactions', l:'Transaksi', i:Receipt},
                                        {id:'wallets', l:'Dompet', i:WalletIcon},
                                        {id:'budgets', l:'Anggaran', i:PiggyBank},
                                        {id:'goals', l:'Target', i:Target},
                                    ].map(x => (
                                        <button key={x.id} onClick={()=>{setTab(x.id); setMobileMenu(false)}} className={cn("flex items-center gap-4 text-lg font-medium p-3 w-full hover:bg-slate-50 rounded-xl transition-colors", tab===x.id ? "bg-blue-50 text-blue-600" : "text-slate-600")}>
                                            <x.i className="h-5 w-5"/> {x.l}
                                        </button>
                                    ))}
                                    
                                    <hr className="my-4 border-slate-100"/>
                                    
                                    <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Analisis & Tools</p>
                                    <button onClick={()=>{setTab('insight'); setMobileMenu(false)}} className={cn("flex items-center gap-4 text-lg font-medium p-3 w-full hover:bg-slate-50 rounded-xl transition-colors", tab==='insight' ? "bg-blue-50 text-blue-600" : "text-slate-600")}><LineChart className="h-5 w-5"/> Insight Bulanan</button>
                                    <button onClick={()=>{setTab('split-bill'); setMobileMenu(false)}} className={cn("flex items-center gap-4 text-lg font-medium p-3 w-full hover:bg-slate-50 rounded-xl transition-colors", tab==='split-bill' ? "bg-blue-50 text-blue-600" : "text-slate-600")}><Users className="h-5 w-5"/> Split Bill</button>
                                    <button onClick={()=>{setTab('ai-advisor'); setMobileMenu(false)}} className={cn("flex items-center gap-4 text-lg font-medium p-3 w-full hover:bg-purple-50 rounded-xl transition-colors", tab==='ai-advisor' ? "bg-purple-50 text-purple-600" : "text-slate-600")}><Sparkles className="h-5 w-5"/> AI Advisor</button>
                                    
                                    <hr className="my-4 border-slate-100"/>
                                    
                                    <p className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Pengaturan</p>
                                    <button onClick={()=>{setSettingsOpen(true); setMobileMenu(false)}} className="flex items-center gap-4 text-lg font-medium p-3 w-full hover:bg-slate-50 rounded-xl text-slate-600"><Settings className="h-5 w-5"/> API Key</button>
                                    <button onClick={exportData} className="flex items-center gap-4 text-lg font-medium p-3 w-full hover:bg-slate-50 rounded-xl text-slate-600"><Download className="h-5 w-5"/> Backup Data</button>
                                    <label className="flex items-center gap-4 text-lg font-medium p-3 w-full hover:bg-slate-50 rounded-xl text-slate-600 cursor-pointer"><Upload className="h-5 w-5"/> Restore Data <input type="file" className="hidden" onChange={importData}/></label>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
